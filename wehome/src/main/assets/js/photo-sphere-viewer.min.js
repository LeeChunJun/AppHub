THREE.DeviceOrientationControls=function(object){var scope=this;this.object=object;this.object.rotation.reorder("YXZ");this.enabled=true;this.deviceOrientation={};this.screenOrientation=0;var onDeviceOrientationChangeEvent=function(event){scope.deviceOrientation=event};var onScreenOrientationChangeEvent=function(){scope.screenOrientation=window.orientation||0};var setObjectQuaternion=function(){var zee=new THREE.Vector3(0,0,1);var euler=new THREE.Euler();var q0=new THREE.Quaternion();var q1=new THREE.Quaternion(-Math.sqrt(0.5),0,0,Math.sqrt(0.5));return function(quaternion,alpha,beta,gamma,orient){euler.set(beta,alpha,-gamma,'YXZ');quaternion.setFromEuler(euler);quaternion.multiply(q1);quaternion.multiply(q0.setFromAxisAngle(zee,-orient))}}();this.connect=function(){onScreenOrientationChangeEvent();window.addEventListener('orientationchange',onScreenOrientationChangeEvent,false);window.addEventListener('deviceorientation',onDeviceOrientationChangeEvent,false);scope.enabled=true};this.disconnect=function(){window.removeEventListener('orientationchange',onScreenOrientationChangeEvent,false);window.removeEventListener('deviceorientation',onDeviceOrientationChangeEvent,false);scope.enabled=false};this.update=function(){if(scope.enabled===false)return;var alpha=scope.deviceOrientation.alpha?THREE.Math.degToRad(scope.deviceOrientation.alpha):0;var beta=scope.deviceOrientation.beta?THREE.Math.degToRad(scope.deviceOrientation.beta):0;var gamma=scope.deviceOrientation.gamma?THREE.Math.degToRad(scope.deviceOrientation.gamma):0;var orient=scope.screenOrientation?THREE.Math.degToRad(scope.screenOrientation):0;setObjectQuaternion(scope.object.quaternion,alpha,beta,gamma,orient)};this.connect()};!function(){"use strict";function e(n,t,r){return("string"==typeof t?t:t.toString()).replace(n.define||a,function(e,t,o,a){return 0===t.indexOf("def.")&&(t=t.substring(4)),t in r||(":"===o?(n.defineParams&&a.replace(n.defineParams,function(e,n,o){r[t]={arg:n,text:o}}),t in r||(r[t]=a)):new Function("def","def['"+t+"']="+a)(r)),""}).replace(n.use||a,function(t,o){n.useParams&&(o=o.replace(n.useParams,function(e,n,t,o){if(r[t]&&r[t].arg&&o){var a=(t+":"+o).replace(/'|\\/g,"_");return r.__exp=r.__exp||{},r.__exp[a]=r[t].text.replace(new RegExp("(^|[^\\w$])"+r[t].arg+"([^\\w$])","g"),"$1"+o+"$2"),n+"def.__exp['"+a+"']"}}));var a=new Function("def","return "+o)(r);return a?e(n,a,r):a})}function n(e){return e.replace(/\\('|\\)/g,"$1").replace(/[\r\t\n]/g," ")}var t,r={engine:"doT",version:"1.1.1",templateSettings:{evaluate:/\{\{([\s\S]+?(\}?)+)\}\}/g,interpolate:/\{\{=([\s\S]+?)\}\}/g,encode:/\{\{!([\s\S]+?)\}\}/g,use:/\{\{#([\s\S]+?)\}\}/g,useParams:/(^|[^\w$])def(?:\.|\[[\'\"])([\w$\.]+)(?:[\'\"]\])?\s*\:\s*([\w$\.]+|\"[^\"]+\"|\'[^\']+\'|\{[^\}]+\})/g,define:/\{\{##\s*([\w\.$]+)\s*(\:|=)([\s\S]+?)#\}\}/g,defineParams:/^\s*([\w$]+):([\s\S]+)/,conditional:/\{\{\?(\?)?\s*([\s\S]*?)\s*\}\}/g,iterate:/\{\{~\s*(?:\}\}|([\s\S]+?)\s*\:\s*([\w$]+)\s*(?:\:\s*([\w$]+))?\s*\}\})/g,varname:"it",strip:!0,append:!0,selfcontained:!1,doNotSkipEncoded:!1},template:void 0,compile:void 0,log:!0};r.encodeHTMLSource=function(e){var n={"&":"&#38;","<":"&#60;",">":"&#62;",'"':"&#34;","'":"&#39;","/":"&#47;"},t=e?/[&<>"'\/]/g:/&(?!#?\w+;)|<|>|"|'|\//g;return function(e){return e?e.toString().replace(t,function(e){return n[e]||e}):""}},t=function(){return this||(0,eval)("this")}(),"undefined"!=typeof module&&module.exports?module.exports=r:"function"==typeof define&&define.amd?define(function(){return r}):t.doT=r;var o={append:{start:"'+(",end:")+'",startencode:"'+encodeHTML("},split:{start:"';out+=(",end:");out+='",startencode:"';out+=encodeHTML("}},a=/$^/;r.template=function(c,i,u){i=i||r.templateSettings;var d,s,p=i.append?o.append:o.split,l=0,f=i.use||i.define?e(i,c,u||{}):c;f=("var out='"+(i.strip?f.replace(/(^|\r|\n)\t* +| +\t*(\r|\n|$)/g," ").replace(/\r|\n|\t|\/\*[\s\S]*?\*\//g,""):f).replace(/'|\\/g,"\\$&").replace(i.interpolate||a,function(e,t){return p.start+n(t)+p.end}).replace(i.encode||a,function(e,t){return d=!0,p.startencode+n(t)+p.end}).replace(i.conditional||a,function(e,t,r){return t?r?"';}else if("+n(r)+"){out+='":"';}else{out+='":r?"';if("+n(r)+"){out+='":"';}out+='"}).replace(i.iterate||a,function(e,t,r,o){return t?(l+=1,s=o||"i"+l,t=n(t),"';var arr"+l+"="+t+";if(arr"+l+"){var "+r+","+s+"=-1,l"+l+"=arr"+l+".length-1;while("+s+"<l"+l+"){"+r+"=arr"+l+"["+s+"+=1];out+='"):"';} } out+='"}).replace(i.evaluate||a,function(e,t){return"';"+n(t)+"out+='"})+"';return out;").replace(/\n/g,"\\n").replace(/\t/g,"\\t").replace(/\r/g,"\\r").replace(/(\s|;|\}|^|\{)out\+='';/g,"$1").replace(/\+''/g,""),d&&(i.selfcontained||!t||t._encodeHTML||(t._encodeHTML=r.encodeHTMLSource(i.doNotSkipEncoded)),f="var encodeHTML = typeof _encodeHTML !== 'undefined' ? _encodeHTML : ("+r.encodeHTMLSource.toString()+"("+(i.doNotSkipEncoded||"")+"));"+f);try{return new Function(i.varname,f)}catch(e){throw"undefined"!=typeof console&&console.log("Could not create a template function: "+f),e}},r.compile=function(e,n){return r.template(e,null,n)}}();!function(a){"use strict";function b(a){l(function(){throw a})}function c(b){return this.then(b,a)}function d(b){return this.then(a,b)}function e(b,c){return this.then(function(a){return m(b)?b.apply(null,n(a)?a:[a]):v.onlyFuncs?a:b},c||a)}function f(a){function b(){a()}return this.then(b,b),this}function g(a){return this.then(function(b){return m(a)?a.apply(null,n(b)?b.splice(0,0,void 0)&&b:[void 0,b]):v.onlyFuncs?b:a},function(b){return a(b)})}function h(c){return this.then(a,c?function(a){throw c(a),a}:b)}function i(a,b){var c=q(a);if(1===c.length&&n(c[0])){if(!c[0].length)return v.fulfilled([]);c=c[0]}var d=[],e=v(),f=c.length;if(f)for(var g=function(a){c[a]=v.promisify(c[a]),c[a].then(function(g){d[a]=b?c[a]:g,--f||e.resolve(d)},function(g){b?(d[a]=c[a],--f||e.resolve(d)):e.reject(g)})},h=0,i=f;i>h;h++)g(h);else e.resolve(d);return e.promise}function j(a,b){return a.then(m(b)?b:function(){return b})}function k(a){var b=q(a);1===b.length&&n(b[0])&&(b=b[0]);for(var c=v(),d=0,e=b.length,f=v.resolved();e>d;d++)f=j(f,b[d]);return c.resolve(f),c.promise}var l,m=function(a){return"function"==typeof a},n=function(a){return Array.isArray?Array.isArray(a):a instanceof Array},o=function(a){return!(!a||!(typeof a).match(/function|object/))},p=function(b){return b===!1||b===a||null===b},q=function(a,b){return[].slice.call(a,b)},r="undefined",s=typeof TypeError===r?Error:TypeError;if(typeof process!==r&&process.nextTick)l=process.nextTick;else if(typeof MessageChannel!==r){var t=new MessageChannel,u=[];t.port1.onmessage=function(){u.length&&u.shift()()},l=function(a){u.push(a),t.port2.postMessage(0)}}else l=function(a){setTimeout(a,0)};var v=function(b){function i(){if(0!==r){var a,b=t,c=0,d=b.length,e=~r?0:1;for(t=[];d>c;c++)(a=b[c][e])&&a(n)}}function j(a){function b(a){return function(b){return c?void 0:(c=!0,a(b))}}var c=!1;if(r)return this;try{var d=o(a)&&a.then;if(m(d)){if(a===u)throw new s("Promise can't resolve itself");return d.call(a,b(j),b(k)),this}}catch(e){return b(k)(e),this}return q(function(){n=a,r=1,i()}),this}function k(a){return r||q(function(){try{throw a}catch(b){n=b}r=-1,i()}),this}var n,q=(a!==b?b:v.alwaysAsync)?l:function(a){a()},r=0,t=[],u={then:function(a,b){var c=v();return t.push([function(b){try{c.resolve(p(a)?b:m(a)?a(b):v.onlyFuncs?b:a)}catch(d){c.reject(d)}},function(a){if((p(b)||!m(b)&&v.onlyFuncs)&&c.reject(a),b)try{c.resolve(m(b)?b(a):b)}catch(d){c.reject(d)}}]),0!==r&&q(i),c.promise},success:c,error:d,otherwise:d,apply:e,spread:e,ensure:f,nodify:g,rethrow:h,isPending:function(){return 0===r},getStatus:function(){return r}};return u.toSource=u.toString=u.valueOf=function(){return n===a?this:n},{promise:u,resolve:j,fulfill:j,reject:k}};if(v.deferred=v.defer=v,v.nextTick=l,v.alwaysAsync=!0,v.onlyFuncs=!0,v.resolved=v.fulfilled=function(a){return v(!0).resolve(a).promise},v.rejected=function(a){return v(!0).reject(a).promise},v.wait=function(a){var b=v();return setTimeout(b.resolve,a||0),b.promise},v.delay=function(a,b){var c=v();return setTimeout(function(){try{c.resolve(m(a)?a.apply(null):a)}catch(b){c.reject(b)}},b||0),c.promise},v.promisify=function(a){return a&&m(a.then)?a:v.resolved(a)},v.all=function(){return i(arguments,!1)},v.resolveAll=function(){return i(arguments,!0)},v.sequence=function(){return k(arguments)},v.nodeCapsule=function(a,b){return b||(b=a,a=void 0),function(){var c=v(),d=q(arguments);d.push(function(a,b){a?c.reject(a):c.resolve(arguments.length>2?q(arguments,1):b)});try{b.apply(a,d)}catch(e){c.reject(e)}return c.promise}},"function"==typeof define&&define.amd)define("D.js",[],function(){return v});else if(typeof module!==r&&module.exports)module.exports=v;else if(typeof window!==r){var w=window.D;v.noConflict=function(){return window.D=w,v},window.D=v}}();!function(a,b){"undefined"!=typeof module&&module.exports?module.exports=b():"function"==typeof define&&define.amd?define([],b):a.uEvent=b()}(this,function(){"use strict";var a=function(){return!0},b=function(){return!1},c=function(){};return c.Event=function(a,b){var c=a,d=b;Object.defineProperties(this,{type:{get:function(){return c},set:function(a){},enumerable:!0},args:{get:function(){return d},set:function(a){},enumerable:!0}})},c.Event.prototype={constructor:c.Event,isDefaultPrevented:b,isPropagationStopped:b,preventDefault:function(){this.isDefaultPrevented=a},stopPropagation:function(){this.isPropagationStopped=a}},c.prototype={constructor:c,on:function(a,b){if(this.__events=this.__events||{},"object"==typeof a)for(var c in a)a.hasOwnProperty(c)&&(this.__events[c]=this.__events[c]||[],this.__events[c].push(a[c]));else a.split(" ").forEach(function(a){this.__events[a]=this.__events[a]||[],this.__events[a].push(b)},this);return this},off:function(a,b){if(this.__events=this.__events||{},"object"==typeof a){for(var c in a)if(a.hasOwnProperty(c)&&c in this.__events){var d=this.__events[c].indexOf(a[c]);-1!==d&&this.__events[c].splice(d,1)}}else a?a.split(" ").forEach(function(a){if(a in this.__events)if(b){var c=this.__events[a].indexOf(b);-1!==c&&this.__events[a].splice(c,1)}else this.__events[a].length=0},this):this.__events={};return this},once:function(a,b){if(this.__once=this.__once||{},"object"==typeof a)for(var c in a)a.hasOwnProperty(c)&&(this.__once[c]=this.__once[c]||[],this.__once[c].push(a[c]));else a.split(" ").forEach(function(a){this.__once[a]=this.__once[a]||[],this.__once[a].push(b)},this);return this},trigger:function(a){var b,d,e,f=Array.prototype.slice.call(arguments,1),g=new c.Event(a,f);if(f.push(g),this.__events&&a in this.__events)for(b=0,d=this.__events[a].length;d>b;b++)if(e=this.__events[a][b],"object"==typeof e?e.handleEvent(g):e.apply(this,f),g.isPropagationStopped())return g;if(this.__once&&a in this.__once){for(b=0,d=this.__once[a].length;d>b;b++)if(e=this.__once[a][b],"object"==typeof e?e.handleEvent(g):e.apply(this,f),g.isPropagationStopped())return delete this.__once[a],g;delete this.__once[a]}return g},change:function(a,b){var d,e,f,g=Array.prototype.slice.call(arguments,1),h=new c.Event(a,g);if(g.push(h),this.__events&&a in this.__events)for(d=0,e=this.__events[a].length;e>d;d++)if(g[0]=b,f=this.__events[a][d],b="object"==typeof f?f.handleEvent(h):f.apply(this,g),h.isPropagationStopped())return b;return b}},c.mixin=function(a,b){b=b||{},a="function"==typeof a?a.prototype:a,["on","off","once","trigger","change"].forEach(function(d){var e=b[d]||d;a[e]=c.prototype[d]}),Object.defineProperties(a,{__events:{value:null,writable:!0},__once:{value:null,writable:!0}})},c});(function(root,factory){if(typeof define==='function'&&define.amd){define(['three','d.js','uevent','dot/doT'],factory)}else if(typeof module==='object'&&module.exports){module.exports=factory(require('three'),require('d.js'),require('uevent'),require('dot/doT'))}else{root.PhotoSphereViewer=factory(root.THREE,root.D,root.uEvent,root.doT)}}(this,function(THREE,D,uEvent,doT){"use strict";function PhotoSphereViewer(options){if(!(this instanceof PhotoSphereViewer)){return new PhotoSphereViewer(options)}if(!PhotoSphereViewer.SYSTEM.loaded){PhotoSphereViewer._loadSystem()}this.config=PSVUtils.clone(PhotoSphereViewer.DEFAULTS);PSVUtils.deepmerge(this.config,options);if(!options.container){throw new PSVError('No value given for container.');}if(!PhotoSphereViewer.SYSTEM.isCanvasSupported){throw new PSVError('Canvas is not supported.');}if((!PhotoSphereViewer.SYSTEM.isWebGLSupported||!this.config.webgl)&&!PSVUtils.checkTHREE('CanvasRenderer','Projector')){throw new PSVError('Missing Three.js components: CanvasRenderer, Projector. Get them from three.js-examples package.');}if(this.config.longitude_range&&this.config.longitude_range.length!==2){this.config.longitude_range=null;console.warn('PhotoSphereViewer: longitude_range must have exactly two elements.')}if(this.config.latitude_range){if(this.config.latitude_range.length!==2){this.config.latitude_range=null;console.warn('PhotoSphereViewer: latitude_range must have exactly two elements.')}else if(this.config.latitude_range[0]>this.config.latitude_range[1]){this.config.latitude_range=[this.config.latitude_range[1],this.config.latitude_range[0]];console.warn('PhotoSphereViewer: latitude_range values must be ordered.')}}else if(this.config.tilt_up_max!==undefined||this.config.tilt_down_max!==undefined){this.config.latitude_range=[this.config.tilt_down_max!==undefined?this.config.tilt_down_max-Math.PI/4:-PSVUtils.HalfPI,this.config.tilt_up_max!==undefined?this.config.tilt_up_max+Math.PI/4:PSVUtils.HalfPI];console.warn('PhotoSphereViewer: tilt_up_max and tilt_down_max are deprecated, use latitude_range instead.')}if(this.config.max_fov<this.config.min_fov){var temp_fov=this.config.max_fov;this.config.max_fov=this.config.min_fov;this.config.min_fov=temp_fov;console.warn('PhotoSphereViewer: max_fov cannot be lower than min_fov.')}if(this.config.cache_texture&&(!PSVUtils.isInteger(this.config.cache_texture)||this.config.cache_texture<0)){this.config.cache_texture=PhotoSphereViewer.DEFAULTS.cache_texture;console.warn('PhotoSphereViewer: invalid value for cache_texture')}if('panorama_roll'in this.config){this.config.sphere_correction.roll=this.config.panorama_roll;console.warn('PhotoSphereViewer: panorama_roll is deprecated, use sphere_correction.roll instead')}this.config.min_fov=PSVUtils.bound(this.config.min_fov,1,179);this.config.max_fov=PSVUtils.bound(this.config.max_fov,1,179);if(this.config.default_fov===null){this.config.default_fov=this.config.max_fov/2+this.config.min_fov/2}else{this.config.default_fov=PSVUtils.bound(this.config.default_fov,this.config.min_fov,this.config.max_fov)}this.config.default_long=PSVUtils.parseAngle(this.config.default_long);this.config.default_lat=PSVUtils.parseAngle(this.config.default_lat,true);this.config.sphere_correction.pan=PSVUtils.parseAngle(this.config.sphere_correction.pan,true);this.config.sphere_correction.tilt=PSVUtils.parseAngle(this.config.sphere_correction.tilt,true);this.config.sphere_correction.roll=PSVUtils.parseAngle(this.config.sphere_correction.roll,true);if(this.config.anim_lat===null){this.config.anim_lat=this.config.default_lat}else{this.config.anim_lat=PSVUtils.parseAngle(this.config.anim_lat,true)}if(this.config.longitude_range){this.config.longitude_range=this.config.longitude_range.map(function(angle){return PSVUtils.parseAngle(angle)})}if(this.config.latitude_range){this.config.latitude_range=this.config.latitude_range.map(function(angle){return PSVUtils.parseAngle(angle,true)})}this.config.anim_speed=PSVUtils.parseSpeed(this.config.anim_speed);if(this.config.caption&&!this.config.navbar){this.config.navbar=['caption']}if(this.config.fisheye===true){this.config.fisheye=1}else if(this.config.fisheye===false){this.config.fisheye=0}this.parent=(typeof options.container=='string')?document.getElementById(options.container):options.container;this.container=null;this.loader=null;this.navbar=null;this.hud=null;this.panel=null;this.tooltip=null;this.canvas_container=null;this.renderer=null;this.scene=null;this.camera=null;this.mesh=null;this.raycaster=null;this.doControls=null;this.prop={isCubemap:undefined,longitude:0,latitude:0,direction:null,anim_speed:0,zoom_lvl:0,vFov:0,hFov:0,aspect:0,move_speed:0.1,moving:false,zooming:false,start_mouse_x:0,start_mouse_y:0,mouse_x:0,mouse_y:0,mouse_history:[],pinch_dist:0,orientation_reqid:null,autorotate_reqid:null,animation_promise:null,loading_promise:null,start_timeout:null,dblclick_data:null,dblclick_timeout:null,cache:[],size:{width:0,height:0},pano_data:{full_width:0,full_height:0,cropped_width:0,cropped_height:0,cropped_x:0,cropped_y:0}};Object.keys(PhotoSphereViewer.TEMPLATES).forEach(function(tpl){if(!this.config.templates[tpl]){this.config.templates[tpl]=PhotoSphereViewer.TEMPLATES[tpl]}if(typeof this.config.templates[tpl]=='string'){this.config.templates[tpl]=doT.template(this.config.templates[tpl])}},this);this.parent.photoSphereViewer=this;this.container=document.createElement('div');this.container.classList.add('psv-container');this.parent.appendChild(this.container);if(this.config.size!==null){this._setViewerSize(this.config.size)}this._onResize();var tempZoom=Math.round((this.config.default_fov-this.config.min_fov)/(this.config.max_fov-this.config.min_fov)*100);this.zoom(tempZoom-2*(tempZoom-50),false);this.prop.move_speed=THREE.Math.degToRad(this.config.move_speed/PhotoSphereViewer.SYSTEM.pixelRatio);this.rotate({longitude:this.config.default_long,latitude:this.config.default_lat},false);this.loader=new PSVLoader(this);this.loader.hide();this.navbar=new PSVNavBar(this);this.navbar.hide();this.hud=new PSVHUD(this);this.hud.hide();this.panel=new PSVPanel(this);this.tooltip=new PSVTooltip(this.hud);this._bindEvents();if(this.config.panorama){this.load()}this.once('render',function(){if(this.config.navbar){this.container.classList.add('psv-container--has-navbar');this.navbar.show()}this.hud.show();if(this.config.markers){this.config.markers.forEach(function(marker){this.hud.addMarker(marker,false)},this);this.hud.renderMarkers()}if(this.config.time_anim!==false){this.prop.start_timeout=window.setTimeout(this.startAutorotate.bind(this),this.config.time_anim)}this.trigger('ready')}.bind(this))}uEvent.mixin(PhotoSphereViewer);PhotoSphereViewer.prototype._loadXMP=function(panorama){if(!this.config.usexmpdata){return D.resolved(null)}var defer=D();var xhr=new XMLHttpRequest();var self=this;var progress=0;xhr.onreadystatechange=function(){if(xhr.readyState===4){if(xhr.status===200||xhr.status===201||xhr.status===202||xhr.status===0){self.loader.setProgress(100);var binary=xhr.responseText;var a=binary.indexOf('<x:xmpmeta'),b=binary.indexOf('</x:xmpmeta>');var data=binary.substring(a,b);if(a===-1||b===-1||data.indexOf('GPano:')===-1){defer.resolve(null)}else{var pano_data={full_width:parseInt(PSVUtils.getXMPValue(data,'FullPanoWidthPixels')),full_height:parseInt(PSVUtils.getXMPValue(data,'FullPanoHeightPixels')),cropped_width:parseInt(PSVUtils.getXMPValue(data,'CroppedAreaImageWidthPixels')),cropped_height:parseInt(PSVUtils.getXMPValue(data,'CroppedAreaImageHeightPixels')),cropped_x:parseInt(PSVUtils.getXMPValue(data,'CroppedAreaLeftPixels')),cropped_y:parseInt(PSVUtils.getXMPValue(data,'CroppedAreaTopPixels'))};if(!pano_data.full_width||!pano_data.full_height||!pano_data.cropped_width||!pano_data.cropped_height){console.warn('PhotoSphereViewer: invalid XMP data');defer.resolve(null)}else{defer.resolve(pano_data)}}}else{self.container.textContent='Cannot load image';throw new PSVError('Cannot load image');}}else if(xhr.readyState===3){self.loader.setProgress(progress+=10)}};xhr.onprogress=function(e){if(e.lengthComputable){var new_progress=parseInt(e.loaded/e.total*100);if(new_progress>progress){progress=new_progress;self.loader.setProgress(progress)}}};xhr.onerror=function(){self.container.textContent='Cannot load image';throw new PSVError('Cannot load image');};xhr.open('GET',panorama,true);xhr.send(null);return defer.promise};PhotoSphereViewer.prototype._loadTexture=function(panorama){var tempPanorama=[];if(Array.isArray(panorama)){if(panorama.length!==6){throw new PSVError('Must provide exactly 6 image paths when using cubemap.');}for(var i=0;i<6;i++){tempPanorama[i]=panorama[PhotoSphereViewer.CUBE_MAP[i]]}panorama=tempPanorama}else if(typeof panorama=='object'){if(!PhotoSphereViewer.CUBE_HASHMAP.every(function(side){return!!panorama[side]})){throw new PSVError('Must provide exactly left, front, right, back, top, bottom when using cubemap.');}PhotoSphereViewer.CUBE_HASHMAP.forEach(function(side,i){tempPanorama[i]=panorama[side]});panorama=tempPanorama}if(Array.isArray(panorama)){if(this.prop.isCubemap===false){throw new PSVError('The viewer was initialized with an equirectangular panorama, cannot switch to cubemap.');}if(this.config.fisheye){console.warn('PhotoSphereViewer: fisheye effect with cubemap texture can generate distorsions.')}if(this.config.cache_texture===PhotoSphereViewer.DEFAULTS.cache_texture){this.config.cache_texture*=6}this.prop.isCubemap=true;return this._loadCubemapTexture(panorama)}else{if(this.prop.isCubemap===true){throw new PSVError('The viewer was initialized with an cubemap, cannot switch to equirectangular panorama.');}this.prop.isCubemap=false;return this._loadEquirectangularTexture(panorama)}};PhotoSphereViewer.prototype._loadEquirectangularTexture=function(panorama){if(this.config.cache_texture){var cache=this.getPanoramaCache(panorama);if(cache){this.prop.pano_data=cache.pano_data;return D.resolved(cache.image)}}return this._loadXMP(panorama).then(function(pano_data){var defer=D();var loader=new THREE.ImageLoader();var progress=pano_data?100:0;loader.setCrossOrigin('anonymous');var onload=function(img){progress=100;this.loader.setProgress(progress);this.trigger('panorama-load-progress',panorama,progress);if(!pano_data&&this.config.pano_data){pano_data=PSVUtils.clone(this.config.pano_data)}if(!pano_data){pano_data={full_width:img.width,full_height:img.height,cropped_width:img.width,cropped_height:img.height,cropped_x:0,cropped_y:0}}this.prop.pano_data=pano_data;var texture;var ratio=Math.min(pano_data.full_width,PhotoSphereViewer.SYSTEM.maxTextureWidth)/pano_data.full_width;if(ratio!==1||pano_data.cropped_width!=pano_data.full_width||pano_data.cropped_height!=pano_data.full_height){var resized_pano_data=PSVUtils.clone(pano_data);resized_pano_data.full_width*=ratio;resized_pano_data.full_height*=ratio;resized_pano_data.cropped_width*=ratio;resized_pano_data.cropped_height*=ratio;resized_pano_data.cropped_x*=ratio;resized_pano_data.cropped_y*=ratio;img.width=resized_pano_data.cropped_width;img.height=resized_pano_data.cropped_height;var buffer=document.createElement('canvas');buffer.width=resized_pano_data.full_width;buffer.height=resized_pano_data.full_height;var ctx=buffer.getContext('2d');ctx.drawImage(img,resized_pano_data.cropped_x,resized_pano_data.cropped_y,resized_pano_data.cropped_width,resized_pano_data.cropped_height);texture=new THREE.Texture(buffer)}else{texture=new THREE.Texture(img)}texture.needsUpdate=true;texture.minFilter=THREE.LinearFilter;texture.generateMipmaps=false;if(this.config.cache_texture){this._putPanoramaCache({panorama:panorama,image:texture,pano_data:pano_data})}defer.resolve(texture)};var onprogress=function(e){if(e.lengthComputable){var new_progress=parseInt(e.loaded/e.total*100);if(new_progress>progress){progress=new_progress;this.loader.setProgress(progress);this.trigger('panorama-load-progress',panorama,progress)}}};var onerror=function(e){this.container.textContent='Cannot load image';defer.reject(e);throw new PSVError('Cannot load image');};loader.load(panorama,onload.bind(this),onprogress.bind(this),onerror.bind(this));return defer.promise}.bind(this))};PhotoSphereViewer.prototype._loadCubemapTexture=function(panorama){var defer=D();var loader=new THREE.ImageLoader();var progress=[0,0,0,0,0,0];var loaded=[];var done=0;loader.setCrossOrigin('anonymous');var onend=function(){loaded.forEach(function(img){img.needsUpdate=true;img.minFilter=THREE.LinearFilter;img.generateMipmaps=false});defer.resolve(loaded)};var onload=function(i,img){done++;progress[i]=100;this.loader.setProgress(PSVUtils.sum(progress)/6);this.trigger('panorama-load-progress',panorama[i],progress[i]);var ratio=Math.min(img.width,PhotoSphereViewer.SYSTEM.maxTextureWidth/2)/img.width;if(ratio!==1){var buffer=document.createElement('canvas');buffer.width=img.width*ratio;buffer.height=img.height*ratio;var ctx=buffer.getContext('2d');ctx.drawImage(img,0,0,buffer.width,buffer.height);loaded[i]=new THREE.Texture(buffer)}else{loaded[i]=new THREE.Texture(img)}if(this.config.cache_texture){this._putPanoramaCache({panorama:panorama[i],image:loaded[i]})}if(done===6){onend()}};var onprogress=function(i,e){if(e.lengthComputable){var new_progress=parseInt(e.loaded/e.total*100);if(new_progress>progress[i]){progress[i]=new_progress;this.loader.setProgress(PSVUtils.sum(progress)/6);this.trigger('panorama-load-progress',panorama[i],progress[i])}}};var onerror=function(i,e){this.container.textContent='Cannot load image';defer.reject(e);throw new PSVError('Cannot load image '+i);};for(var i=0;i<6;i++){if(this.config.cache_texture){var cache=this.getPanoramaCache(panorama[i]);if(cache){done++;progress[i]=100;loaded[i]=cache.image;continue}}loader.load(panorama[i],onload.bind(this,i),onprogress.bind(this,i),onerror.bind(this,i))}if(done===6){defer.resolve(loaded)}return defer.promise};PhotoSphereViewer.prototype._setTexture=function(texture){if(!this.scene){this._createScene()}if(this.prop.isCubemap){for(var i=0;i<6;i++){if(this.mesh.material[i].map){this.mesh.material[i].map.dispose()}this.mesh.material[i].map=texture[i]}}else{if(this.mesh.material.map){this.mesh.material.map.dispose()}this.mesh.material.map=texture}this.trigger('panorama-loaded');this.render()};PhotoSphereViewer.prototype._createScene=function(){this.raycaster=new THREE.Raycaster();this.renderer=PhotoSphereViewer.SYSTEM.isWebGLSupported&&this.config.webgl?new THREE.WebGLRenderer():new THREE.CanvasRenderer();this.renderer.setSize(this.prop.size.width,this.prop.size.height);this.renderer.setPixelRatio(PhotoSphereViewer.SYSTEM.pixelRatio);var cameraDistance=PhotoSphereViewer.SPHERE_RADIUS;if(this.prop.isCubemap){cameraDistance*=Math.sqrt(3)}if(this.config.fisheye){cameraDistance+=PhotoSphereViewer.SPHERE_RADIUS}this.camera=new THREE.PerspectiveCamera(this.config.default_fov,this.prop.size.width/this.prop.size.height,1,cameraDistance);this.camera.position.set(0,0,0);if(this.config.gyroscope&&PSVUtils.checkTHREE('DeviceOrientationControls')){this.doControls=new THREE.DeviceOrientationControls(this.camera)}this.scene=new THREE.Scene();this.scene.add(this.camera);if(this.prop.isCubemap){this._createCubemap()}else{this._createSphere()}this.canvas_container=document.createElement('div');this.canvas_container.className='psv-canvas-container';this.renderer.domElement.className='psv-canvas';this.container.appendChild(this.canvas_container);this.canvas_container.appendChild(this.renderer.domElement)};PhotoSphereViewer.prototype._createSphere=function(){var geometry=new THREE.SphereGeometry(PhotoSphereViewer.SPHERE_RADIUS,PhotoSphereViewer.SPHERE_VERTICES,PhotoSphereViewer.SPHERE_VERTICES,-PSVUtils.HalfPI);var material=new THREE.MeshBasicMaterial({side:THREE.DoubleSide,overdraw:PhotoSphereViewer.SYSTEM.isWebGLSupported&&this.config.webgl?0:1});this.mesh=new THREE.Mesh(geometry,material);this.mesh.scale.x=-1;this.mesh.rotation.x=this.config.sphere_correction.tilt;this.mesh.rotation.y=this.config.sphere_correction.pan;this.mesh.rotation.z=this.config.sphere_correction.roll;this.scene.add(this.mesh)};PhotoSphereViewer.prototype._createCubemap=function(){var geometry=new THREE.BoxGeometry(PhotoSphereViewer.SPHERE_RADIUS*2,PhotoSphereViewer.SPHERE_RADIUS*2,PhotoSphereViewer.SPHERE_RADIUS*2,PhotoSphereViewer.CUBE_VERTICES,PhotoSphereViewer.CUBE_VERTICES,PhotoSphereViewer.CUBE_VERTICES);var materials=[];for(var i=0;i<6;i++){materials.push(new THREE.MeshBasicMaterial({side:THREE.BackSide,overdraw:PhotoSphereViewer.SYSTEM.isWebGLSupported&&this.config.webgl?0:1}))}this.mesh=new THREE.Mesh(geometry,materials);this.mesh.position.x-=PhotoSphereViewer.SPHERE_RADIUS;this.mesh.position.y-=PhotoSphereViewer.SPHERE_RADIUS;this.mesh.position.z-=PhotoSphereViewer.SPHERE_RADIUS;this.mesh.applyMatrix(new THREE.Matrix4().makeScale(1,1,-1));this.scene.add(this.mesh)};PhotoSphereViewer.prototype._transition=function(texture,position){if(this.prop.isCubemap){throw new PSVError('Transition is not available with cubemap.');}var self=this;var geometry=new THREE.SphereGeometry(PhotoSphereViewer.SPHERE_RADIUS*0.9,PhotoSphereViewer.SPHERE_VERTICES,PhotoSphereViewer.SPHERE_VERTICES,-PSVUtils.HalfPI);var material=new THREE.MeshBasicMaterial({side:THREE.DoubleSide,overdraw:PhotoSphereViewer.SYSTEM.isWebGLSupported&&this.config.webgl?0:1,map:texture,transparent:true,opacity:0});var mesh=new THREE.Mesh(geometry,material);mesh.scale.x=-1;if(position){mesh.rotateY(position.longitude-this.prop.longitude);var axis=new THREE.Vector3(0,1,0).cross(this.camera.getWorldDirection()).normalize();var q=new THREE.Quaternion().setFromAxisAngle(axis,position.latitude-this.prop.latitude);mesh.quaternion.multiplyQuaternions(q,mesh.quaternion)}this.scene.add(mesh);this.render();return PSVUtils.animation({properties:{opacity:{start:0.0,end:1.0}},duration:self.config.transition.duration,easing:'outCubic',onTick:function(properties){material.opacity=properties.opacity;self.render()}}).then(function(){self.mesh.material.map.dispose();self.mesh.material.map=texture;self.scene.remove(mesh);mesh.geometry.dispose();mesh.geometry=null;mesh.material.dispose();mesh.material=null;if(position){if(self.config.latitude_range||self.config.longitude_range){self.config.longitude_range=self.config.latitude_range=null;console.warn('PhotoSphereViewer: trying to perform transition with longitude_range and/or latitude_range, ranges cleared.')}self.rotate(position)}else{self.render()}})};PhotoSphereViewer.prototype._reverseAutorotate=function(){var self=this;var newSpeed=-this.config.anim_speed;var range=this.config.longitude_range;this.config.longitude_range=null;PSVUtils.animation({properties:{speed:{start:this.config.anim_speed,end:0}},duration:300,easing:'inSine',onTick:function(properties){self.config.anim_speed=properties.speed}}).then(function(){return PSVUtils.animation({properties:{speed:{start:0,end:newSpeed}},duration:300,easing:'outSine',onTick:function(properties){self.config.anim_speed=properties.speed}})}).then(function(){self.config.longitude_range=range;self.config.anim_speed=newSpeed})};PhotoSphereViewer.prototype._putPanoramaCache=function(cache){if(!this.config.cache_texture){throw new PSVError('Cannot add panorama to cache, cache_texture is disabled');}var existingCache=this.getPanoramaCache(cache.panorama);if(existingCache){existingCache.image=cache.image;existingCache.pano_data=cache.pano_data}else{this.prop.cache=this.prop.cache.slice(0,this.config.cache_texture-1);this.prop.cache.unshift(cache)}this.trigger('panorama-cached',cache.panorama)};PhotoSphereViewer.prototype._stopAll=function(){this.stopAutorotate();this.stopAnimation();this.stopGyroscopeControl()};PhotoSphereViewer.MOVE_THRESHOLD=4;PhotoSphereViewer.ANGLE_THRESHOLD=0.003;PhotoSphereViewer.DBLCLICK_DELAY=300;PhotoSphereViewer.INERTIA_WINDOW=300;PhotoSphereViewer.SPHERE_RADIUS=100;PhotoSphereViewer.SPHERE_VERTICES=64;PhotoSphereViewer.CUBE_VERTICES=8;PhotoSphereViewer.CUBE_MAP=[0,2,4,5,3,1];PhotoSphereViewer.CUBE_HASHMAP=['left','right','top','bottom','back','front'];PhotoSphereViewer.KEYMAP={33:'PageUp',34:'PageDown',37:'ArrowLeft',38:'ArrowUp',39:'ArrowRight',40:'ArrowDown',107:'+',109:'-'};PhotoSphereViewer.SYSTEM={loaded:false,pixelRatio:1,isWebGLSupported:false,isCanvasSupported:false,deviceOrientationSupported:null,maxTextureWidth:0,mouseWheelEvent:null,fullscreenEvent:null};PhotoSphereViewer.ICONS={};PhotoSphereViewer.DEFAULTS={panorama:null,container:null,caption:null,usexmpdata:true,pano_data:null,webgl:true,min_fov:30,max_fov:90,default_fov:null,default_long:0,default_lat:0,sphere_correction:{pan:0,tilt:0,roll:0},longitude_range:null,latitude_range:null,move_speed:1,time_anim:2000,anim_speed:'2rpm',anim_lat:null,fisheye:false,navbar:['autorotate','zoom','download','markers','caption','gyroscope','fullscreen'],tooltip:{offset:5,arrow_size:7,delay:100},lang:{autorotate:'Automatic rotation',zoom:'Zoom',zoomOut:'Zoom out',zoomIn:'Zoom in',download:'Download',fullscreen:'Fullscreen',markers:'Markers',gyroscope:'Gyroscope'},mousewheel:true,mousewheel_factor:1,mousemove:true,keyboard:true,gyroscope:false,move_inertia:true,click_event_on_marker:false,transition:{duration:1500,loader:true},loading_img:null,loading_txt:'Loading...',size:null,cache_texture:0,templates:{},markers:[]};PhotoSphereViewer.TEMPLATES={markersList:'<div class="psv-markers-list-container">   <h1 class="psv-markers-list-title">{{= it.config.lang.markers }}</h1>   <ul class="psv-markers-list">   {{~ it.markers: marker }}     <li data-psv-marker="{{= marker.id }}" class="psv-markers-list-item {{? marker.className }}{{= marker.className }}{{?}}">       {{? marker.image }}<img class="psv-markers-list-image" src="{{= marker.image }}"/>{{?}}       <p class="psv-markers-list-name">{{? marker.tooltip }}{{= marker.tooltip.content }}{{?? marker.html }}{{= marker.html }}{{??}}{{= marker.id }}{{?}}</p>     </li>   {{~}}   </ul> </div>'};PhotoSphereViewer.prototype._bindEvents=function(){window.addEventListener('resize',this);if(this.config.mousemove){this.hud.container.style.cursor='move';this.hud.container.addEventListener('mousedown',this);this.hud.container.addEventListener('touchstart',this);window.addEventListener('mouseup',this);window.addEventListener('touchend',this);this.hud.container.addEventListener('mousemove',this);this.hud.container.addEventListener('touchmove',this)}if(PhotoSphereViewer.SYSTEM.fullscreenEvent){document.addEventListener(PhotoSphereViewer.SYSTEM.fullscreenEvent,this)}if(this.config.mousewheel){this.hud.container.addEventListener(PhotoSphereViewer.SYSTEM.mouseWheelEvent,this)}this.on('_side-reached',function(side){if(this.isAutorotateEnabled()){if(side==='left'||side==='right'){this._reverseAutorotate()}}})};PhotoSphereViewer.prototype.handleEvent=function(evt){switch(evt.type){case'resize':PSVUtils.throttle(this._onResize(),50);break;case'keydown':this._onKeyDown(evt);break;case'mousedown':this._onMouseDown(evt);break;case'touchstart':this._onTouchStart(evt);break;case'mouseup':this._onMouseUp(evt);break;case'touchend':this._onTouchEnd(evt);break;case'mousemove':this._onMouseMove(evt);break;case'touchmove':this._onTouchMove(evt);break;case PhotoSphereViewer.SYSTEM.fullscreenEvent:this._fullscreenToggled();break;case PhotoSphereViewer.SYSTEM.mouseWheelEvent:this._onMouseWheel(evt);break}};PhotoSphereViewer.prototype._onResize=function(){if(this.container.clientWidth!=this.prop.size.width||this.container.clientHeight!=this.prop.size.height){this.prop.size.width=parseInt(this.container.clientWidth);this.prop.size.height=parseInt(this.container.clientHeight);this.prop.aspect=this.prop.size.width/this.prop.size.height;if(this.renderer){this.renderer.setSize(this.prop.size.width,this.prop.size.height);if(this.composer){this.composer.reset(new THREE.WebGLRenderTarget(this.prop.size.width,this.prop.size.height))}this.render()}this.trigger('size-updated',this.getSize())}};PhotoSphereViewer.prototype._onKeyDown=function(evt){var dLong=0;var dLat=0;var dZoom=0;var key=evt.key||PhotoSphereViewer.KEYMAP[evt.keyCode||evt.which];switch(key){case'ArrowUp':dLat=0.01;break;case'ArrowDown':dLat=-0.01;break;case'ArrowRight':dLong=0.01;break;case'ArrowLeft':dLong=-0.01;break;case'PageUp':case'+':dZoom=1;break;case'PageDown':case'-':dZoom=-1;break}if(dZoom!==0){this.zoom(this.prop.zoom_lvl+dZoom)}else if(dLat!==0||dLong!==0){this.rotate({longitude:this.prop.longitude+dLong*this.prop.move_speed*this.prop.hFov,latitude:this.prop.latitude+dLat*this.prop.move_speed*this.prop.vFov})}};PhotoSphereViewer.prototype._onMouseDown=function(evt){this._startMove(evt)};PhotoSphereViewer.prototype._onMouseUp=function(evt){this._stopMove(evt)};PhotoSphereViewer.prototype._onMouseMove=function(evt){if(evt.buttons!==0){evt.preventDefault();this._move(evt)}};PhotoSphereViewer.prototype._onTouchStart=function(evt){if(evt.touches.length===1){this._startMove(evt.touches[0])}else if(evt.touches.length===2){this._startZoom(evt)}};PhotoSphereViewer.prototype._onTouchEnd=function(evt){this._stopMove(evt.changedTouches[0])};PhotoSphereViewer.prototype._onTouchMove=function(evt){if(evt.touches.length===1){evt.preventDefault();this._move(evt.touches[0])}else if(evt.touches.length===2){evt.preventDefault();this._zoom(evt)}};PhotoSphereViewer.prototype._startMove=function(evt){if(this.isGyroscopeEnabled()){return}this._stopAll();this.prop.mouse_x=this.prop.start_mouse_x=parseInt(evt.clientX);this.prop.mouse_y=this.prop.start_mouse_y=parseInt(evt.clientY);this.prop.moving=true;this.prop.zooming=false;this.prop.mouse_history.length=0;this._logMouseMove(evt)};PhotoSphereViewer.prototype._startZoom=function(evt){var t=[{x:parseInt(evt.touches[0].clientX),y:parseInt(evt.touches[0].clientY)},{x:parseInt(evt.touches[1].clientX),y:parseInt(evt.touches[1].clientY)}];this.prop.pinch_dist=Math.sqrt(Math.pow(t[0].x-t[1].x,2)+Math.pow(t[0].y-t[1].y,2));this.prop.moving=false;this.prop.zooming=true};PhotoSphereViewer.prototype._stopMove=function(evt){if(!PSVUtils.getClosest(evt.target,'.psv-hud')){return}if(this.isGyroscopeEnabled()){this._click(evt);return}if(this.prop.moving){if(Math.abs(evt.clientX-this.prop.start_mouse_x)<PhotoSphereViewer.MOVE_THRESHOLD&&Math.abs(evt.clientY-this.prop.start_mouse_y)<PhotoSphereViewer.MOVE_THRESHOLD){this._click(evt);this.prop.moving=false}else if(this.config.move_inertia){this._logMouseMove(evt);this._stopMoveInertia(evt)}else{this.prop.moving=false}this.prop.mouse_history.length=0}this.prop.zooming=false};PhotoSphereViewer.prototype._stopMoveInertia=function(evt){var self=this;var direction={x:evt.clientX-this.prop.mouse_history[0][1],y:evt.clientY-this.prop.mouse_history[0][2]};var norm=Math.sqrt(direction.x*direction.x+direction.y*direction.y);this.prop.animation_promise=PSVUtils.animation({properties:{clientX:{start:evt.clientX,end:evt.clientX+direction.x},clientY:{start:evt.clientY,end:evt.clientY+direction.y}},duration:norm*PhotoSphereViewer.INERTIA_WINDOW/100,easing:'outCirc',onTick:function(properties){self._move(properties,false)}}).ensure(function(){self.prop.moving=false})};PhotoSphereViewer.prototype._click=function(evt){var boundingRect=this.container.getBoundingClientRect();var data={target:evt.target,client_x:evt.clientX,client_y:evt.clientY,viewer_x:parseInt(evt.clientX-boundingRect.left),viewer_y:parseInt(evt.clientY-boundingRect.top)};var intersect=this.viewerCoordsToVector3({x:data.viewer_x,y:data.viewer_y});if(intersect){var sphericalCoords=this.vector3ToSphericalCoords(intersect);data.longitude=sphericalCoords.longitude;data.latitude=sphericalCoords.latitude;if(!this.prop.isCubemap){var textureCoords=this.sphericalCoordsToTextureCoords({longitude:data.longitude,latitude:data.latitude});data.texture_x=textureCoords.x;data.texture_y=textureCoords.y}if(!this.prop.dblclick_timeout){this.trigger('click',data);this.prop.dblclick_data=PSVUtils.clone(data);this.prop.dblclick_timeout=setTimeout(function(){this.prop.dblclick_timeout=null;this.prop.dblclick_data=null}.bind(this),PhotoSphereViewer.DBLCLICK_DELAY)}else{if(Math.abs(this.prop.dblclick_data.client_x-data.client_x)<PhotoSphereViewer.MOVE_THRESHOLD&&Math.abs(this.prop.dblclick_data.client_y-data.client_y)<PhotoSphereViewer.MOVE_THRESHOLD){this.trigger('dblclick',this.prop.dblclick_data)}clearTimeout(this.prop.dblclick_timeout);this.prop.dblclick_timeout=null;this.prop.dblclick_data=null}}};PhotoSphereViewer.prototype._move=function(evt,log){if(this.prop.moving){var x=parseInt(evt.clientX);var y=parseInt(evt.clientY);this.rotate({longitude:this.prop.longitude-(x-this.prop.mouse_x)/this.prop.size.width*this.prop.move_speed*this.prop.hFov,latitude:this.prop.latitude+(y-this.prop.mouse_y)/this.prop.size.height*this.prop.move_speed*this.prop.vFov});this.prop.mouse_x=x;this.prop.mouse_y=y;if(log!==false){this._logMouseMove(evt)}}};PhotoSphereViewer.prototype._zoom=function(evt){if(this.prop.zooming){var t=[{x:parseInt(evt.touches[0].clientX),y:parseInt(evt.touches[0].clientY)},{x:parseInt(evt.touches[1].clientX),y:parseInt(evt.touches[1].clientY)}];var p=Math.sqrt(Math.pow(t[0].x-t[1].x,2)+Math.pow(t[0].y-t[1].y,2));var delta=80*(p-this.prop.pinch_dist)/this.prop.size.width;this.zoom(this.prop.zoom_lvl+delta);this.prop.pinch_dist=p}};PhotoSphereViewer.prototype._onMouseWheel=function(evt){evt.preventDefault();evt.stopPropagation();var delta=PSVUtils.normalizeWheel(evt).spinY*5;if(delta!==0){this.zoom(this.prop.zoom_lvl-delta*this.config.mousewheel_factor)}};PhotoSphereViewer.prototype._fullscreenToggled=function(){var enabled=this.isFullscreenEnabled();if(this.config.keyboard){if(enabled){this.startKeyboardControl()}else{this.stopKeyboardControl()}}this.trigger('fullscreen-updated',enabled)};PhotoSphereViewer.prototype._logMouseMove=function(evt){var now=Date.now();this.prop.mouse_history.push([now,evt.clientX,evt.clientY]);var previous=null;for(var i=0;i<this.prop.mouse_history.length;){if(this.prop.mouse_history[0][i]<now-PhotoSphereViewer.INERTIA_WINDOW){this.prop.mouse_history.splice(i,1)}else if(previous&&this.prop.mouse_history[0][i]-previous>PhotoSphereViewer.INERTIA_WINDOW/10){this.prop.mouse_history.splice(0,i);i=0;previous=this.prop.mouse_history[0][i]}else{i++;previous=this.prop.mouse_history[0][i]}}};PhotoSphereViewer.prototype.load=function(){if(!this.config.panorama){throw new PSVError('No value given for panorama.');}return this.setPanorama(this.config.panorama,false)};PhotoSphereViewer.prototype.getPosition=function(){return{longitude:this.prop.longitude,latitude:this.prop.latitude}};PhotoSphereViewer.prototype.getZoomLevel=function(){return this.prop.zoom_lvl};PhotoSphereViewer.prototype.getSize=function(){return{width:this.prop.size.width,height:this.prop.size.height}};PhotoSphereViewer.prototype.isAutorotateEnabled=function(){return!!this.prop.autorotate_reqid};PhotoSphereViewer.prototype.isGyroscopeEnabled=function(){return!!this.prop.orientation_reqid};PhotoSphereViewer.prototype.isFullscreenEnabled=function(){return PSVUtils.isFullscreenEnabled(this.container)};PhotoSphereViewer.prototype.render=function(updateDirection){if(updateDirection!==false){this.prop.direction=this.sphericalCoordsToVector3(this.prop);this.camera.position.set(0,0,0);this.camera.lookAt(this.prop.direction)}if(this.config.fisheye){this.camera.position.copy(this.prop.direction).multiplyScalar(this.config.fisheye/2).negate()}this.camera.aspect=this.prop.aspect;this.camera.fov=this.prop.vFov;this.camera.updateProjectionMatrix();if(this.composer){this.composer.render()}else{this.renderer.render(this.scene,this.camera)}this.trigger('render')};PhotoSphereViewer.prototype.destroy=function(){this._stopAll();this.stopKeyboardControl();if(this.isFullscreenEnabled()){PSVUtils.exitFullscreen()}window.removeEventListener('resize',this);if(this.config.mousemove){this.hud.container.removeEventListener('mousedown',this);this.hud.container.removeEventListener('touchstart',this);window.removeEventListener('mouseup',this);window.removeEventListener('touchend',this);this.hud.container.removeEventListener('mousemove',this);this.hud.container.removeEventListener('touchmove',this)}if(PhotoSphereViewer.SYSTEM.fullscreenEvent){document.removeEventListener(PhotoSphereViewer.SYSTEM.fullscreenEvent,this)}if(this.config.mousewheel){this.hud.container.removeEventListener(PhotoSphereViewer.SYSTEM.mouseWheelEvent,this)}if(this.tooltip)this.tooltip.destroy();if(this.hud)this.hud.destroy();if(this.loader)this.loader.destroy();if(this.navbar)this.navbar.destroy();if(this.panel)this.panel.destroy();if(this.doControls)this.doControls.disconnect();if(this.scene){PSVUtils.cleanTHREEScene(this.scene)}if(this.canvas_container){this.container.removeChild(this.canvas_container)}this.parent.removeChild(this.container);delete this.parent.photoSphereViewer;delete this.parent;delete this.container;delete this.loader;delete this.navbar;delete this.hud;delete this.panel;delete this.tooltip;delete this.canvas_container;delete this.renderer;delete this.composer;delete this.scene;delete this.camera;delete this.mesh;delete this.doControls;delete this.raycaster;delete this.passes;delete this.config;this.prop.cache.length=0};PhotoSphereViewer.prototype.setPanorama=function(path,position,transition){if(this.prop.loading_promise!==null){throw new PSVError('Loading already in progress');}if(typeof position=='boolean'){transition=position;position=undefined}if(transition&&this.prop.isCubemap){throw new PSVError('Transition is not available with cubemap.');}if(position){this.cleanPosition(position);this._stopAll()}this.config.panorama=path;var self=this;if(!transition||!this.config.transition||!this.scene){this.loader.show();if(this.canvas_container){this.canvas_container.style.opacity=0}this.prop.loading_promise=this._loadTexture(this.config.panorama).then(function(texture){self._setTexture(texture);if(position){self.rotate(position)}}).ensure(function(){self.loader.hide();self.canvas_container.style.opacity=1;self.prop.loading_promise=null}).rethrow();}else{if(this.config.transition.loader){this.loader.show()}this.prop.loading_promise=this._loadTexture(this.config.panorama).then(function(texture){self.loader.hide();return self._transition(texture,position)}).ensure(function(){self.loader.hide();self.prop.loading_promise=null}).rethrow();}return this.prop.loading_promise};PhotoSphereViewer.prototype.startAutorotate=function(){this._stopAll();var self=this;var last=null;var elapsed=null;(function run(timestamp){if(timestamp){elapsed=last===null?0:timestamp-last;last=timestamp;self.rotate({longitude:self.prop.longitude+self.config.anim_speed*elapsed/1000,latitude:self.prop.latitude-(self.prop.latitude-self.config.anim_lat)/200})}self.prop.autorotate_reqid=window.requestAnimationFrame(run)}(null));this.trigger('autorotate',true)};PhotoSphereViewer.prototype.stopAutorotate=function(){if(this.prop.start_timeout){window.clearTimeout(this.prop.start_timeout);this.prop.start_timeout=null}if(this.prop.autorotate_reqid){window.cancelAnimationFrame(this.prop.autorotate_reqid);this.prop.autorotate_reqid=null;this.trigger('autorotate',false)}};PhotoSphereViewer.prototype.toggleAutorotate=function(){if(this.isAutorotateEnabled()){this.stopAutorotate()}else{this.startAutorotate()}};PhotoSphereViewer.prototype.startGyroscopeControl=function(){if(!this.doControls||!this.doControls.enabled||!this.doControls.deviceOrientation){console.warn('PhotoSphereViewer: gyroscope disabled');return}this._stopAll();var self=this;(function run(){self.doControls.update();self.prop.direction=self.camera.getWorldDirection();var sphericalCoords=self.vector3ToSphericalCoords(self.prop.direction);self.prop.longitude=sphericalCoords.longitude;self.prop.latitude=sphericalCoords.latitude;self.render(false);self.prop.orientation_reqid=window.requestAnimationFrame(run)}());this.trigger('gyroscope-updated',true)};PhotoSphereViewer.prototype.stopGyroscopeControl=function(){if(this.prop.orientation_reqid){window.cancelAnimationFrame(this.prop.orientation_reqid);this.prop.orientation_reqid=null;this.trigger('gyroscope-updated',false);this.render()}};PhotoSphereViewer.prototype.toggleGyroscopeControl=function(){if(this.isGyroscopeEnabled()){this.stopGyroscopeControl()}else{this.startGyroscopeControl()}};PhotoSphereViewer.prototype.rotate=function(position,render){this.cleanPosition(position);this.applyRanges(position).forEach(this.trigger.bind(this,'_side-reached'));this.prop.longitude=position.longitude;this.prop.latitude=position.latitude;if(render!==false&&this.renderer){this.render();this.trigger('position-updated',this.getPosition())}};PhotoSphereViewer.prototype.animate=function(position,duration){this._stopAll();this.cleanPosition(position);if(!duration||Math.abs(position.longitude-this.prop.longitude)<PhotoSphereViewer.ANGLE_THRESHOLD&&Math.abs(position.latitude-this.prop.latitude)<PhotoSphereViewer.ANGLE_THRESHOLD){this.rotate(position);return D.resolved()}this.applyRanges(position).forEach(this.trigger.bind(this,'_side-reached'));if(!duration&&typeof duration!='number'){duration=duration?PSVUtils.parseSpeed(duration):this.config.anim_speed;var angle=Math.acos(Math.cos(this.prop.latitude)*Math.cos(position.latitude)*Math.cos(this.prop.longitude-position.longitude)+Math.sin(this.prop.latitude)*Math.sin(position.latitude));duration=angle/duration*1000}var tOffset=PSVUtils.getShortestArc(this.prop.longitude,position.longitude);this.prop.animation_promise=PSVUtils.animation({properties:{longitude:{start:this.prop.longitude,end:this.prop.longitude+tOffset},latitude:{start:this.prop.latitude,end:position.latitude}},duration:duration,easing:'inOutSine',onTick:this.rotate.bind(this)});return this.prop.animation_promise};PhotoSphereViewer.prototype.stopAnimation=function(){if(this.prop.animation_promise){this.prop.animation_promise.cancel();this.prop.animation_promise=null}};PhotoSphereViewer.prototype.zoom=function(level,render){this.prop.zoom_lvl=PSVUtils.bound(Math.round(level),0,100);this.prop.vFov=this.config.max_fov+(this.prop.zoom_lvl/100)*(this.config.min_fov-this.config.max_fov);this.prop.hFov=THREE.Math.radToDeg(2*Math.atan(Math.tan(THREE.Math.degToRad(this.prop.vFov)/2)*this.prop.aspect));if(render!==false&&this.renderer){this.render();this.trigger('zoom-updated',this.getZoomLevel())}};PhotoSphereViewer.prototype.zoomIn=function(){if(this.prop.zoom_lvl<100){this.zoom(this.prop.zoom_lvl+1)}};PhotoSphereViewer.prototype.zoomOut=function(){if(this.prop.zoom_lvl>0){this.zoom(this.prop.zoom_lvl-1)}};PhotoSphereViewer.prototype.resize=function(size){if(size.width){this.container.style.width=size.width}if(size.height){this.container.style.height=size.height}this._onResize()};PhotoSphereViewer.prototype.toggleFullscreen=function(){if(!this.isFullscreenEnabled()){PSVUtils.requestFullscreen(this.container)}else{PSVUtils.exitFullscreen()}};PhotoSphereViewer.prototype.startKeyboardControl=function(){window.addEventListener('keydown',this)};PhotoSphereViewer.prototype.stopKeyboardControl=function(){window.removeEventListener('keydown',this)};PhotoSphereViewer.prototype.preloadPanorama=function(panorama){if(!this.config.cache_texture){throw new PSVError('Cannot preload panorama, cache_texture is disabled');}return this._loadTexture(panorama)};PhotoSphereViewer.prototype.clearPanoramaCache=function(panorama){if(!this.config.cache_texture){throw new PSVError('Cannot clear cache, cache_texture is disabled');}if(panorama){for(var i=0,l=this.prop.cache.length;i<l;i++){if(this.prop.cache[i].panorama===panorama){this.prop.cache.splice(i,1);break}}}else{this.prop.cache.length=0}};PhotoSphereViewer.prototype.getPanoramaCache=function(panorama){if(!this.config.cache_texture){throw new PSVError('Cannot query cache, cache_texture is disabled');}return this.prop.cache.filter(function(cache){return cache.panorama===panorama}).shift()};PhotoSphereViewer._loadSystem=function(){var S=PhotoSphereViewer.SYSTEM;S.loaded=true;S.pixelRatio=window.devicePixelRatio||1;S.isWebGLSupported=PSVUtils.isWebGLSupported();S.isCanvasSupported=PSVUtils.isCanvasSupported();S.maxTextureWidth=S.isWebGLSupported?PSVUtils.getMaxTextureWidth():4096;S.mouseWheelEvent=PSVUtils.mouseWheelEvent();S.fullscreenEvent=PSVUtils.fullscreenEvent();S.deviceOrientationSupported=D();if('DeviceOrientationEvent'in window){window.addEventListener('deviceorientation',PhotoSphereViewer._deviceOrientationListener,false)}else{S.deviceOrientationSupported.reject()}};PhotoSphereViewer._deviceOrientationListener=function(event){if(event.alpha!==null&&!isNaN(event.alpha)){PhotoSphereViewer.SYSTEM.deviceOrientationSupported.resolve()}else{PhotoSphereViewer.SYSTEM.deviceOrientationSupported.reject()}window.removeEventListener('deviceorientation',PhotoSphereViewer._deviceOrientationListener)};PhotoSphereViewer.prototype._setViewerSize=function(size){['width','height'].forEach(function(dim){if(size[dim]){if(/^[0-9.]+$/.test(size[dim]))size[dim]+='px';this.parent.style[dim]=size[dim]}},this)};PhotoSphereViewer.prototype.textureCoordsToSphericalCoords=function(point){if(this.prop.isCubemap){throw new PSVError('Unable to use texture coords with cubemap.');}var relativeX=(point.x+this.prop.pano_data.cropped_x)/this.prop.pano_data.full_width*PSVUtils.TwoPI;var relativeY=(point.y+this.prop.pano_data.cropped_y)/this.prop.pano_data.full_height*Math.PI;return{longitude:relativeX>=Math.PI?relativeX-Math.PI:relativeX+Math.PI,latitude:PSVUtils.HalfPI-relativeY}};PhotoSphereViewer.prototype.sphericalCoordsToTextureCoords=function(position){if(this.prop.isCubemap){throw new PSVError('Unable to use texture coords with cubemap.');}var relativeLong=position.longitude/PSVUtils.TwoPI*this.prop.pano_data.full_width;var relativeLat=position.latitude/Math.PI*this.prop.pano_data.full_height;return{x:parseInt(position.longitude<Math.PI?relativeLong+this.prop.pano_data.full_width/2:relativeLong-this.prop.pano_data.full_width/2)-this.prop.pano_data.cropped_x,y:parseInt(this.prop.pano_data.full_height/2-relativeLat)-this.prop.pano_data.cropped_y}};PhotoSphereViewer.prototype.sphericalCoordsToVector3=function(position){return new THREE.Vector3(PhotoSphereViewer.SPHERE_RADIUS*-Math.cos(position.latitude)*Math.sin(position.longitude),PhotoSphereViewer.SPHERE_RADIUS*Math.sin(position.latitude),PhotoSphereViewer.SPHERE_RADIUS*Math.cos(position.latitude)*Math.cos(position.longitude))};PhotoSphereViewer.prototype.vector3ToSphericalCoords=function(vector){var phi=Math.acos(vector.y/Math.sqrt(vector.x*vector.x+vector.y*vector.y+vector.z*vector.z));var theta=Math.atan2(vector.x,vector.z);return{longitude:theta<0?-theta:PSVUtils.TwoPI-theta,latitude:PSVUtils.HalfPI-phi}};PhotoSphereViewer.prototype.viewerCoordsToVector3=function(viewerPoint){var screen=new THREE.Vector2(2*viewerPoint.x/this.prop.size.width-1,-2*viewerPoint.y/this.prop.size.height+1);this.raycaster.setFromCamera(screen,this.camera);var intersects=this.raycaster.intersectObjects(this.scene.children);if(intersects.length===1){return intersects[0].point}else{return null}};PhotoSphereViewer.prototype.vector3ToViewerCoords=function(vector){vector=vector.clone();vector.project(this.camera);return{x:parseInt((vector.x+1)/2*this.prop.size.width),y:parseInt((1-vector.y)/2*this.prop.size.height)}};PhotoSphereViewer.prototype.cleanPosition=function(position){if(position.hasOwnProperty('x')&&position.hasOwnProperty('y')){PSVUtils.deepmerge(position,this.textureCoordsToSphericalCoords(position))}position.longitude=PSVUtils.parseAngle(position.longitude);position.latitude=PSVUtils.parseAngle(position.latitude,true)};PhotoSphereViewer.prototype.applyRanges=function(position){var range,offset,sidesReached=[];if(this.config.longitude_range){range=PSVUtils.clone(this.config.longitude_range);offset=THREE.Math.degToRad(this.prop.hFov)/2;range[0]=PSVUtils.parseAngle(range[0]+offset);range[1]=PSVUtils.parseAngle(range[1]-offset);if(range[0]>range[1]){if(position.longitude>range[1]&&position.longitude<range[0]){if(position.longitude>(range[0]/2+range[1]/2)){position.longitude=range[0];sidesReached.push('left')}else{position.longitude=range[1];sidesReached.push('right')}}}else{if(position.longitude<range[0]){position.longitude=range[0];sidesReached.push('left')}else if(position.longitude>range[1]){position.longitude=range[1];sidesReached.push('right')}}}if(this.config.latitude_range){range=PSVUtils.clone(this.config.latitude_range);offset=THREE.Math.degToRad(this.prop.vFov)/2;range[0]=PSVUtils.parseAngle(Math.min(range[0]+offset,range[1]),true);range[1]=PSVUtils.parseAngle(Math.max(range[1]-offset,range[0]),true);if(position.latitude<range[0]){position.latitude=range[0];sidesReached.push('bottom')}else if(position.latitude>range[1]){position.latitude=range[1];sidesReached.push('top')}}return sidesReached};function PSVComponent(parent){this.psv=parent instanceof PhotoSphereViewer?parent:parent.psv;this.parent=parent;this.container=null;if(this.constructor.publicMethods){this.constructor.publicMethods.forEach(function(method){this.psv[method]=this[method].bind(this)},this)}}PSVComponent.className=null;PSVComponent.publicMethods=[];PSVComponent.prototype.create=function(){this.container=document.createElement('div');if(this.constructor.className){this.container.className=this.constructor.className}this.parent.container.appendChild(this.container)};PSVComponent.prototype.destroy=function(){this.parent.container.removeChild(this.container);if(this.constructor.publicMethods){this.constructor.publicMethods.forEach(function(method){delete this.psv[method]},this)}delete this.container;delete this.psv;delete this.parent};PSVComponent.prototype.hide=function(){this.container.style.display='none'};PSVComponent.prototype.show=function(){this.container.style.display=''};function PSVHUD(psv){PSVComponent.call(this,psv);this.svgContainer=null;this.markers={};this.currentMarker=null;this.hoveringMarker=null;this.prop={panelOpened:false,panelOpening:false,markersButton:this.psv.navbar.getNavbarButton('markers',true)};this.create()}PSVHUD.prototype=Object.create(PSVComponent.prototype);PSVHUD.prototype.constructor=PSVHUD;PSVHUD.className='psv-hud';PSVHUD.publicMethods=['addMarker','removeMarker','updateMarker','clearMarkers','getMarker','getCurrentMarker','gotoMarker','hideMarker','showMarker','toggleMarker','toggleMarkersList','showMarkersList','hideMarkersList'];PSVHUD.prototype.create=function(){PSVComponent.prototype.create.call(this);this.svgContainer=document.createElementNS(PSVUtils.svgNS,'svg');this.svgContainer.setAttribute('class','psv-hud-svg-container');this.container.appendChild(this.svgContainer);this.container.addEventListener('mouseenter',this,true);this.container.addEventListener('mouseleave',this,true);this.container.addEventListener('mousemove',this,true);this.psv.on('click',this);this.psv.on('dblclick',this);this.psv.on('render',this);this.psv.on('open-panel',this);this.psv.on('close-panel',this)};PSVHUD.prototype.destroy=function(){this.clearMarkers(false);this.container.removeEventListener('mouseenter',this);this.container.removeEventListener('mouseleave',this);this.container.removeEventListener('mousemove',this);this.psv.off('click',this);this.psv.off('dblclick',this);this.psv.off('render',this);this.psv.off('open-panel',this);this.psv.off('close-panel',this);delete this.svgContainer;PSVComponent.prototype.destroy.call(this)};PSVHUD.prototype.handleEvent=function(e){switch(e.type){case'mouseenter':this._onMouseEnter(e);break;case'mouseleave':this._onMouseLeave(e);break;case'mousemove':this._onMouseMove(e);break;case'click':this._onClick(e.args[0],e,false);break;case'dblclick':this._onClick(e.args[0],e,true);break;case'render':this.renderMarkers();break;case'open-panel':this._onPanelOpened();break;case'close-panel':this._onPanelClosed();break}};PSVHUD.prototype.addMarker=function(properties,render){if(!properties.id){throw new PSVError('missing marker id');}if(this.markers[properties.id]){throw new PSVError('marker "'+properties.id+'" already exists');}var marker=new PSVMarker(properties,this.psv);if(marker.isNormal()){this.container.appendChild(marker.$el)}else{this.svgContainer.appendChild(marker.$el)}this.markers[marker.id]=marker;if(render!==false){this.renderMarkers()}return marker};PSVHUD.prototype.getMarker=function(markerId){var id=typeof markerId==='object'?markerId.id:markerId;if(!this.markers[id]){throw new PSVError('cannot find marker "'+id+'"');}return this.markers[id]};PSVHUD.prototype.getCurrentMarker=function(){return this.currentMarker};PSVHUD.prototype.updateMarker=function(properties,render){var marker=this.getMarker(properties);marker.update(properties);if(render!==false){this.renderMarkers()}return marker};PSVHUD.prototype.removeMarker=function(marker,render){marker=this.getMarker(marker);if(marker.isNormal()){this.container.removeChild(marker.$el)}else{this.svgContainer.removeChild(marker.$el)}if(this.hoveringMarker==marker){this.psv.tooltip.hideTooltip()}marker.destroy();delete this.markers[marker.id];if(render!==false){this.renderMarkers()}};PSVHUD.prototype.clearMarkers=function(render){Object.keys(this.markers).forEach(function(marker){this.removeMarker(marker,false)},this);if(render!==false){this.renderMarkers()}};PSVHUD.prototype.gotoMarker=function(marker,duration){marker=this.getMarker(marker);return this.psv.animate(marker,duration).then(function(){this.psv.trigger('goto-marker-done',marker)}.bind(this))};PSVHUD.prototype.hideMarker=function(marker){this.getMarker(marker).visible=false;this.renderMarkers()};PSVHUD.prototype.showMarker=function(marker){this.getMarker(marker).visible=true;this.renderMarkers()};PSVHUD.prototype.toggleMarker=function(marker){this.getMarker(marker).visible^=true;this.renderMarkers()};PSVHUD.prototype.toggleMarkersList=function(){if(this.prop.panelOpened){this.hideMarkersList()}else{this.showMarkersList()}};PSVHUD.prototype.showMarkersList=function(){var markers=[];for(var id in this.markers){markers.push(this.markers[id])}var html=this.psv.config.templates.markersList({markers:this.psv.change('render-markers-list',markers),config:this.psv.config});this.prop.panelOpening=true;this.psv.panel.showPanel(html,true);this.psv.panel.container.querySelector('.psv-markers-list').addEventListener('click',this._onClickItem.bind(this))};PSVHUD.prototype.hideMarkersList=function(){if(this.prop.panelOpened){this.psv.panel.hidePanel()}};PSVHUD.prototype.renderMarkers=function(){var rotation=!this.psv.isGyroscopeEnabled()?0:THREE.Math.radToDeg(this.psv.camera.rotation.z);for(var id in this.markers){var marker=this.markers[id];var isVisible=marker.visible;if(isVisible&&marker.isPoly()){var positions=this._getPolyPositions(marker);isVisible=positions.length>(marker.isPolygon()?2:1);if(isVisible){marker.position2D=this._getPolyDimensions(marker,positions);var points='';positions.forEach(function(pos){points+=pos.x+','+pos.y+' '});marker.$el.setAttributeNS(null,'points',points)}}else if(isVisible){var position=this._getMarkerPosition(marker);isVisible=this._isMarkerVisible(marker,position);if(isVisible){marker.position2D=position;var scale=marker.getScale(this.psv.getZoomLevel());if(marker.isSvg()){marker.$el.setAttributeNS(null,'transform','translate('+position.x+', '+position.y+')'+(scale!==1?' scale('+scale+', '+scale+')':'')+(!marker.lockRotation&&rotation?' rotate('+rotation+')':''))}else{marker.$el.style.transform='translate3D('+position.x+'px, '+position.y+'px, 0px)'+(scale!==1?' scale('+scale+', '+scale+')':'')+(!marker.lockRotation&&rotation?' rotateZ('+rotation+'deg)':'')}}}PSVUtils.toggleClass(marker.$el,'psv-marker--visible',isVisible)}};PSVHUD.prototype._isMarkerVisible=function(marker,position){return marker.position3D.dot(this.psv.prop.direction)>0&&position.x+marker.width>=0&&position.x-marker.width<=this.psv.prop.size.width&&position.y+marker.height>=0&&position.y-marker.height<=this.psv.prop.size.height};PSVHUD.prototype._getMarkerPosition=function(marker){if(marker._dynamicSize){PSVUtils.toggleClass(marker.$el,'psv-marker--transparent',true);var transform=marker.$el.style.transform;marker.$el.style.transform=null;var rect=marker.$el.getBoundingClientRect();marker.$el.style.transform=transform;PSVUtils.toggleClass(marker.$el,'psv-marker--transparent',false);marker.width=rect.right-rect.left;marker.height=rect.bottom-rect.top}var position=this.psv.vector3ToViewerCoords(marker.position3D);position.x-=marker.width*marker.anchor.left;position.y-=marker.height*marker.anchor.top;return position};PSVHUD.prototype._getPolyPositions=function(marker){var nbVectors=marker.positions3D.length;var positions3D=marker.positions3D.map(function(vector){return{vector:vector,visible:vector.dot(this.psv.prop.direction)>0}},this);var toBeComputed=[];positions3D.forEach(function(pos,i){if(!pos.visible){var neighbours=[i===0?positions3D[nbVectors-1]:positions3D[i-1],i===nbVectors-1?positions3D[0]:positions3D[i+1]];neighbours.forEach(function(neighbour){if(neighbour.visible){toBeComputed.push({visible:neighbour,invisible:pos,index:i})}})}});toBeComputed.reverse().forEach(function(pair){positions3D.splice(pair.index,0,{vector:this._getPolyIntermediaryPoint(pair.visible.vector,pair.invisible.vector),visible:true})},this);return positions3D.filter(function(pos){return pos.visible}).map(function(pos){return this.psv.vector3ToViewerCoords(pos.vector)},this)};PSVHUD.prototype._getPolyIntermediaryPoint=function(P1,P2){var C=this.psv.prop.direction.clone().normalize();var N=new THREE.Vector3().crossVectors(P1,P2).normalize();var V=new THREE.Vector3().crossVectors(N,P1).normalize();var H=new THREE.Vector3().addVectors(P1.clone().multiplyScalar(-C.dot(V)),V.clone().multiplyScalar(C.dot(P1))).normalize();var a=new THREE.Vector3().crossVectors(H,C);return H.applyAxisAngle(a,0.01).multiplyScalar(PhotoSphereViewer.SPHERE_RADIUS)};PSVHUD.prototype._getPolyDimensions=function(marker,positions){var minX=+Infinity;var minY=+Infinity;var maxX=-Infinity;var maxY=-Infinity;positions.forEach(function(pos){minX=Math.min(minX,pos.x);minY=Math.min(minY,pos.y);maxX=Math.max(maxX,pos.x);maxY=Math.max(maxY,pos.y)});marker.width=maxX-minX;marker.height=maxY-minY;return{x:minX,y:minY}};PSVHUD.prototype._onMouseEnter=function(e){var marker;if(e.target&&(marker=e.target.psvMarker)&&!marker.isPoly()){this.hoveringMarker=marker;this.psv.trigger('over-marker',marker);if(marker.tooltip){this.psv.tooltip.showTooltip({content:marker.tooltip.content,position:marker.tooltip.position,left:marker.position2D.x,top:marker.position2D.y,box:{width:marker.width,height:marker.height}})}}};PSVHUD.prototype._onMouseLeave=function(e){var marker;if(e.target&&(marker=e.target.psvMarker)){if(marker.isPoly()&&e.relatedTarget&&PSVUtils.hasParent(e.relatedTarget,this.psv.tooltip.container)){return}this.psv.trigger('leave-marker',marker);this.hoveringMarker=null;this.psv.tooltip.hideTooltip()}};PSVHUD.prototype._onMouseMove=function(e){if(!this.psv.prop.moving){var marker;if(e.target&&(marker=e.target.psvMarker)&&marker.isPoly()||e.target&&PSVUtils.hasParent(e.target,this.psv.tooltip.container)&&(marker=this.hoveringMarker)){if(!this.hoveringMarker){this.psv.trigger('over-marker',marker);this.hoveringMarker=marker}var boundingRect=this.psv.container.getBoundingClientRect();if(marker.tooltip){this.psv.tooltip.showTooltip({content:marker.tooltip.content,position:marker.tooltip.position,top:e.clientY-boundingRect.top-this.psv.config.tooltip.arrow_size/2,left:e.clientX-boundingRect.left-this.psv.config.tooltip.arrow_size,box:{width:this.psv.config.tooltip.arrow_size*2,height:this.psv.config.tooltip.arrow_size*2}})}}else if(this.hoveringMarker&&this.hoveringMarker.isPoly()){this.psv.trigger('leave-marker',marker);this.hoveringMarker=null;this.psv.tooltip.hideTooltip()}}};PSVHUD.prototype._onClick=function(data,e,dblclick){var marker;if(data.target&&(marker=PSVUtils.getClosest(data.target,'.psv-marker'))&&marker.psvMarker){this.currentMarker=marker.psvMarker;this.psv.trigger('select-marker',this.currentMarker,dblclick);if(this.psv.config.click_event_on_marker){data.marker=marker.psvMarker}else{e.stopPropagation()}}else if(this.currentMarker){this.psv.trigger('unselect-marker',this.currentMarker);this.currentMarker=null}if(marker&&marker.psvMarker&&marker.psvMarker.content){this.psv.panel.showPanel(marker.psvMarker.content)}else if(this.psv.panel.prop.opened){e.stopPropagation();this.psv.panel.hidePanel()}};PSVHUD.prototype._onClickItem=function(e){var li;if(e.target&&(li=PSVUtils.getClosest(e.target,'li'))&&li.dataset.psvMarker){var marker=this.getMarker(li.dataset.psvMarker);this.psv.trigger('select-marker-list',marker);this.gotoMarker(marker,1000);this.psv.panel.hidePanel()}};PSVHUD.prototype._onPanelOpened=function(){if(this.prop.panelOpening){this.prop.panelOpening=false;this.prop.panelOpened=true}else{this.prop.panelOpened=false}if(this.prop.markersButton){this.prop.markersButton.toggleActive(this.prop.panelOpened)}};PSVHUD.prototype._onPanelClosed=function(){this.prop.panelOpened=false;this.prop.panelOpening=false;if(this.prop.markersButton){this.prop.markersButton.toggleActive(false)}};function PSVLoader(psv){PSVComponent.call(this,psv);this.canvas=null;this.loader=null;this.create()}PSVLoader.prototype=Object.create(PSVComponent.prototype);PSVLoader.prototype.constructor=PSVLoader;PSVLoader.className='psv-loader-container';PSVLoader.prototype.create=function(){PSVComponent.prototype.create.call(this);this.loader=document.createElement('div');this.loader.className='psv-loader';this.container.appendChild(this.loader);this.canvas=document.createElement('canvas');this.canvas.className='psv-loader-canvas';this.canvas.width=this.loader.clientWidth;this.canvas.height=this.loader.clientWidth;this.loader.appendChild(this.canvas);this.tickness=(this.loader.offsetWidth-this.loader.clientWidth)/2;var inner;if(this.psv.config.loading_img){inner=document.createElement('img');inner.className='psv-loader-image';inner.src=this.psv.config.loading_img}else if(this.psv.config.loading_txt){inner=document.createElement('div');inner.className='psv-loader-text';inner.innerHTML=this.psv.config.loading_txt}if(inner){var a=Math.round(Math.sqrt(2*Math.pow(this.canvas.width/2-this.tickness/2,2)));inner.style.maxWidth=a+'px';inner.style.maxHeight=a+'px';this.loader.appendChild(inner)}};PSVLoader.prototype.destroy=function(){delete this.loader;delete this.canvas;PSVComponent.prototype.destroy.call(this)};PSVLoader.prototype.setProgress=function(value){var context=this.canvas.getContext('2d');context.clearRect(0,0,this.canvas.width,this.canvas.height);context.lineWidth=this.tickness;context.strokeStyle=PSVUtils.getStyle(this.loader,'color');context.beginPath();context.arc(this.canvas.width/2,this.canvas.height/2,this.canvas.width/2-this.tickness/2,-Math.PI/2,value/100*2*Math.PI-Math.PI/2);context.stroke()};function PSVNavBar(psv){PSVComponent.call(this,psv);this.config=this.psv.config.navbar;this.items=[];if(this.config===true){this.config=PSVUtils.clone(PhotoSphereViewer.DEFAULTS.navbar)}else if(typeof this.config=='string'){this.config=this.config.split(' ')}else if(!Array.isArray(this.config)){console.warn('PhotoSphereViewer: hashmap form of "navbar" is deprecated, use an array instead.');var config=this.config;this.config=[];for(var key in config){if(config[key]){this.config.push(key)}}this.config.sort(function(a,b){return PhotoSphereViewer.DEFAULTS.navbar.indexOf(a)-PhotoSphereViewer.DEFAULTS.navbar.indexOf(b)})}this.create()}PSVNavBar.prototype=Object.create(PSVComponent.prototype);PSVNavBar.prototype.constructor=PSVNavBar;PSVNavBar.className='psv-navbar psv-navbar--open';PSVNavBar.publicMethods=['showNavbar','hideNavbar','toggleNavbar','getNavbarButton'];PSVNavBar.prototype.create=function(){PSVComponent.prototype.create.call(this);this.config.forEach(function(button){if(typeof button=='object'){this.items.push(new PSVNavBarCustomButton(this,button))}else{switch(button){case PSVNavBarAutorotateButton.id:this.items.push(new PSVNavBarAutorotateButton(this));break;case PSVNavBarZoomButton.id:this.items.push(new PSVNavBarZoomButton(this));break;case PSVNavBarDownloadButton.id:this.items.push(new PSVNavBarDownloadButton(this));break;case PSVNavBarMarkersButton.id:this.items.push(new PSVNavBarMarkersButton(this));break;case PSVNavBarFullscreenButton.id:this.items.push(new PSVNavBarFullscreenButton(this));break;case PSVNavBarGyroscopeButton.id:if(this.psv.config.gyroscope){this.items.push(new PSVNavBarGyroscopeButton(this))}break;case'caption':this.items.push(new PSVNavBarCaption(this,this.psv.config.caption));break;case'spacer':button='spacer-5';default:var matches=button.match(/^spacer\-([0-9]+)$/);if(matches!==null){this.items.push(new PSVNavBarSpacer(this,matches[1]))}else{throw new PSVError('Unknown button '+button);}break}}},this)};PSVNavBar.prototype.destroy=function(){this.items.forEach(function(item){item.destroy()});delete this.items;delete this.config;PSVComponent.prototype.destroy.call(this)};PSVNavBar.prototype.getNavbarButton=function(id,silent){var button=null;this.items.some(function(item){if(item.id===id){button=item;return true}});if(!button&&!silent){console.warn('PhotoSphereViewer: button "'+id+'" not found in the navbar.')}return button};PSVNavBar.prototype.showNavbar=function(){this.toggleNavbar(true)};PSVNavBar.prototype.hideNavbar=function(){this.toggleNavbar(false)};PSVNavBar.prototype.toggleNavbar=function(active){PSVUtils.toggleClass(this.container,'psv-navbar--open',active)};function PSVNavBarCaption(navbar,caption){PSVComponent.call(this,navbar);this.create();this.setCaption(caption)}PSVNavBarCaption.prototype=Object.create(PSVComponent.prototype);PSVNavBarCaption.prototype.constructor=PSVNavBarCaption;PSVNavBarCaption.className='psv-caption';PSVNavBarCaption.publicMethods=['setCaption'];PSVNavBarCaption.prototype.setCaption=function(html){if(!html){this.container.innerHTML=''}else{this.container.innerHTML=html}};function PSVNavBarSpacer(navbar,weight){PSVComponent.call(this,navbar);this.weight=weight||5;this.create();this.container.classList.add('psv-spacer--weight-'+this.weight)}PSVNavBarSpacer.prototype=Object.create(PSVComponent.prototype);PSVNavBarSpacer.prototype.constructor=PSVNavBarSpacer;PSVNavBarSpacer.className='psv-spacer';function PSVPanel(psv){PSVComponent.call(this,psv);this.content=null;this.prop={mouse_x:0,mouse_y:0,mousedown:false,opened:false};this.create()}PSVPanel.prototype=Object.create(PSVComponent.prototype);PSVPanel.prototype.constructor=PSVPanel;PSVPanel.className='psv-panel';PSVPanel.publicMethods=['showPanel','hidePanel'];PSVPanel.prototype.create=function(){PSVComponent.prototype.create.call(this);this.container.innerHTML='<div class="psv-panel-resizer"></div>'+'<div class="psv-panel-close-button"></div>'+'<div class="psv-panel-content"></div>';this.content=this.container.querySelector('.psv-panel-content');var closeBtn=this.container.querySelector('.psv-panel-close-button');closeBtn.addEventListener('click',this.hidePanel.bind(this));if(this.psv.config.mousewheel){this.container.addEventListener(PhotoSphereViewer.SYSTEM.mouseWheelEvent,function(e){e.stopPropagation()})}var resizer=this.container.querySelector('.psv-panel-resizer');resizer.addEventListener('mousedown',this);resizer.addEventListener('touchstart',this);this.psv.container.addEventListener('mouseup',this);this.psv.container.addEventListener('touchend',this);this.psv.container.addEventListener('mousemove',this);this.psv.container.addEventListener('touchmove',this)};PSVPanel.prototype.destroy=function(){this.psv.container.removeEventListener('mousemove',this);this.psv.container.removeEventListener('touchmove',this);this.psv.container.removeEventListener('mouseup',this);this.psv.container.removeEventListener('touchend',this);delete this.prop;delete this.content;PSVComponent.prototype.destroy.call(this)};PSVPanel.prototype.handleEvent=function(e){switch(e.type){case'mousedown':this._onMouseDown(e);break;case'touchstart':this._onTouchStart(e);break;case'mousemove':this._onMouseMove(e);break;case'touchmove':this._onTouchMove(e);break;case'mouseup':this._onMouseUp(e);break;case'touchend':this._onMouseUp(e);break}};PSVPanel.prototype.showPanel=function(content,noMargin){this.content.innerHTML=content;this.content.scrollTop=0;this.container.classList.add('psv-panel--open');PSVUtils.toggleClass(this.content,'psv-panel-content--no-margin',!!noMargin);this.prop.opened=true;this.psv.trigger('open-panel')};PSVPanel.prototype.hidePanel=function(){this.content.innerHTML=null;this.prop.opened=false;this.container.classList.remove('psv-panel--open');this.psv.trigger('close-panel')};PSVPanel.prototype._onMouseDown=function(evt){evt.stopPropagation();this._startResize(evt)};PSVPanel.prototype._onTouchStart=function(evt){evt.stopPropagation();this._startResize(evt.changedTouches[0])};PSVPanel.prototype._onMouseUp=function(evt){if(this.prop.mousedown){evt.stopPropagation();this.prop.mousedown=false;this.content.classList.remove('psv-panel-content--no-interaction')}};PSVPanel.prototype._onMouseMove=function(evt){if(this.prop.mousedown){evt.stopPropagation();this._resize(evt)}};PSVPanel.prototype._onTouchMove=function(evt){if(this.prop.mousedown){evt.stopPropagation();this._resize(evt.touches[0])}};PSVPanel.prototype._startResize=function(evt){this.prop.mouse_x=parseInt(evt.clientX);this.prop.mouse_y=parseInt(evt.clientY);this.prop.mousedown=true;this.content.classList.add('psv-panel-content--no-interaction')};PSVPanel.prototype._resize=function(evt){var x=parseInt(evt.clientX);var y=parseInt(evt.clientY);this.container.style.width=(this.container.offsetWidth-(x-this.prop.mouse_x))+'px';this.prop.mouse_x=x;this.prop.mouse_y=y};function PSVTooltip(hud){PSVComponent.call(this,hud);this.config=this.psv.config.tooltip;this.prop={timeout:null};this.create()}PSVTooltip.prototype=Object.create(PSVComponent.prototype);PSVTooltip.prototype.constructor=PSVTooltip;PSVTooltip.className='psv-tooltip';PSVTooltip.publicMethods=['showTooltip','hideTooltip','isTooltipVisible'];PSVTooltip.leftMap={0:'left',0.5:'center',1:'right'};PSVTooltip.topMap={0:'top',0.5:'center',1:'bottom'};PSVTooltip.prototype.create=function(){PSVComponent.prototype.create.call(this);this.container.innerHTML='<div class="psv-tooltip-arrow"></div><div class="psv-tooltip-content"></div>';this.container.style.top='-1000px';this.container.style.left='-1000px';this.content=this.container.querySelector('.psv-tooltip-content');this.arrow=this.container.querySelector('.psv-tooltip-arrow');this.psv.on('render',this)};PSVTooltip.prototype.destroy=function(){this.psv.off('render',this);delete this.config;delete this.prop;PSVComponent.prototype.destroy.call(this)};PSVTooltip.prototype.handleEvent=function(e){switch(e.type){case'render':this.hideTooltip();break}};PSVTooltip.prototype.isTooltipVisible=function(){return this.container.classList.contains('psv-tooltip--visible')};PSVTooltip.prototype.showTooltip=function(config){if(this.prop.timeout){window.clearTimeout(this.prop.timeout);this.prop.timeout=null}var isUpdate=this.isTooltipVisible();var t=this.container;var c=this.content;var a=this.arrow;if(!config.position){config.position=['top','center']}if(!config.box){config.box={width:0,height:0}}if(typeof config.position==='string'){var tempPos=PSVUtils.parsePosition(config.position);if(!(tempPos.left in PSVTooltip.leftMap)||!(tempPos.top in PSVTooltip.topMap)){throw new PSVError('unable to parse tooltip position "'+tooltip.position+'"');}config.position=[PSVTooltip.topMap[tempPos.top],PSVTooltip.leftMap[tempPos.left]]}if(config.position[0]=='center'&&config.position[1]=='center'){throw new PSVError('unable to parse tooltip position "center center"');}if(isUpdate){for(var i=t.classList.length-1;i>=0;i--){var item=t.classList.item(i);if(item!='psv-tooltip'&&item!='psv-tooltip--visible'){t.classList.remove(item)}}}else{t.className='psv-tooltip'}if(config.className){PSVUtils.addClasses(t,config.className)}c.innerHTML=config.content;t.style.top='0px';t.style.left='0px';var rect=t.getBoundingClientRect();var style={posClass:config.position.slice(),width:rect.right-rect.left,height:rect.bottom-rect.top,top:0,left:0,arrow_top:0,arrow_left:0};this._computeTooltipPosition(style,config);var refresh=false;if(style.top<this.config.offset){style.posClass[0]='bottom';refresh=true}else if(style.top+style.height>this.psv.prop.size.height-this.config.offset){style.posClass[0]='top';refresh=true}if(style.left<this.config.offset){style.posClass[1]='right';refresh=true}else if(style.left+style.width>this.psv.prop.size.width-this.config.offset){style.posClass[1]='left';refresh=true}if(refresh){this._computeTooltipPosition(style,config)}t.style.top=style.top+'px';t.style.left=style.left+'px';a.style.top=style.arrow_top+'px';a.style.left=style.arrow_left+'px';t.classList.add('psv-tooltip--'+style.posClass.join('-'));if(!isUpdate){var self=this;this.prop.timeout=window.setTimeout(function(){t.classList.add('psv-tooltip--visible');self.prop.timeout=null;self.psv.trigger('show-tooltip')},this.config.delay)}};PSVTooltip.prototype.hideTooltip=function(){if(this.prop.timeout){window.clearTimeout(this.prop.timeout);this.prop.timeout=null}if(this.isTooltipVisible()){this.container.classList.remove('psv-tooltip--visible');var self=this;this.prop.timeout=window.setTimeout(function(){self.content.innerHTML=null;self.container.style.top='-1000px';self.container.style.left='-1000px';self.prop.timeout=null},this.config.delay);this.psv.trigger('hide-tooltip')}};PSVTooltip.prototype._computeTooltipPosition=function(style,config){var topBottom=false;switch(style.posClass[0]){case'bottom':style.top=config.top+config.box.height+this.config.offset+this.config.arrow_size;style.arrow_top=-this.config.arrow_size*2;topBottom=true;break;case'center':style.top=config.top+config.box.height/2-style.height/2;style.arrow_top=style.height/2-this.config.arrow_size;break;case'top':style.top=config.top-style.height-this.config.offset-this.config.arrow_size;style.arrow_top=style.height;topBottom=true;break}switch(style.posClass[1]){case'right':if(topBottom){style.left=config.left+config.box.width/2-this.config.offset-this.config.arrow_size;style.arrow_left=this.config.offset}else{style.left=config.left+config.box.width+this.config.offset+this.config.arrow_size;style.arrow_left=-this.config.arrow_size*2}break;case'center':style.left=config.left+config.box.width/2-style.width/2;style.arrow_left=style.width/2-this.config.arrow_size;break;case'left':if(topBottom){style.left=config.left-style.width+config.box.width/2+this.config.offset+this.config.arrow_size;style.arrow_left=style.width-this.config.offset-this.config.arrow_size*2}else{style.left=config.left-style.width-this.config.offset-this.config.arrow_size;style.arrow_left=style.width}break}};function PSVNavBarButton(navbar){PSVComponent.call(this,navbar);this.id=undefined;if(this.constructor.id){this.id=this.constructor.id}this.enabled=true}PSVNavBarButton.prototype=Object.create(PSVComponent.prototype);PSVNavBarButton.prototype.constructor=PSVNavBarButton;PSVNavBarButton.id=null;PSVNavBarButton.icon=null;PSVNavBarButton.iconActive=null;PSVNavBarButton.prototype.create=function(){PSVComponent.prototype.create.call(this);if(this.constructor.icon){this._setIcon(this.constructor.icon)}if(this.id&&this.psv.config.lang[this.id]){this.container.title=this.psv.config.lang[this.id]}this.container.addEventListener('click',function(e){if(this.enabled){this._onClick()}e.stopPropagation()}.bind(this))};PSVNavBarButton.prototype.destroy=function(){PSVComponent.prototype.destroy.call(this)};PSVNavBarButton.prototype.toggleActive=function(active){PSVUtils.toggleClass(this.container,'psv-button--active',active);if(this.constructor.iconActive){this._setIcon(active?this.constructor.iconActive:this.constructor.icon)}};PSVNavBarButton.prototype.disable=function(){this.container.classList.add('psv-button--disabled');this.enabled=false};PSVNavBarButton.prototype.enable=function(){this.container.classList.remove('psv-button--disabled');this.enabled=true};PSVNavBarButton.prototype._setIcon=function(icon,container){if(!container){container=this.container}if(icon){container.innerHTML=PhotoSphereViewer.ICONS[icon];container.querySelector('svg').setAttribute('class','psv-button-svg')}else{container.innerHTML=''}};PSVNavBarButton.prototype._onClick=function(){};function PSVNavBarAutorotateButton(navbar){PSVNavBarButton.call(this,navbar);this.create()}PSVNavBarAutorotateButton.prototype=Object.create(PSVNavBarButton.prototype);PSVNavBarAutorotateButton.prototype.constructor=PSVNavBarAutorotateButton;PSVNavBarAutorotateButton.id='autorotate';PSVNavBarAutorotateButton.className='psv-button psv-button--hover-scale psv-autorotate-button';PSVNavBarAutorotateButton.icon='play.svg';PSVNavBarAutorotateButton.iconActive='play-active.svg';PSVNavBarAutorotateButton.prototype.create=function(){PSVNavBarButton.prototype.create.call(this);this.psv.on('autorotate',this)};PSVNavBarAutorotateButton.prototype.destroy=function(){this.psv.off('autorotate',this);PSVNavBarButton.prototype.destroy.call(this)};PSVNavBarAutorotateButton.prototype.handleEvent=function(e){switch(e.type){case'autorotate':this.toggleActive(e.args[0]);break}};PSVNavBarAutorotateButton.prototype._onClick=function(){this.psv.toggleAutorotate()};function PSVNavBarCustomButton(navbar,config){PSVNavBarButton.call(this,navbar);this.config=config;if(this.config.id){this.id=this.config.id}this.create()}PSVNavBarCustomButton.prototype=Object.create(PSVNavBarButton.prototype);PSVNavBarCustomButton.prototype.constructor=PSVNavBarCustomButton;PSVNavBarCustomButton.className='psv-button psv-custom-button';PSVNavBarCustomButton.prototype.create=function(){PSVNavBarButton.prototype.create.call(this);if(this.config.className){PSVUtils.addClasses(this.container,this.config.className)}if(this.config.title){this.container.title=this.config.title}if(this.config.content){this.container.innerHTML=this.config.content}if(this.config.enabled===false||this.config.disabled===true){this.disable()}if(this.config.visible===false||this.config.hidden===true){this.hide()}};PSVNavBarCustomButton.prototype.destroy=function(){delete this.config;PSVNavBarButton.prototype.destroy.call(this)};PSVNavBarCustomButton.prototype._onClick=function(){if(this.config.onClick){this.config.onClick.apply(this.psv)}};function PSVNavBarDownloadButton(navbar){PSVNavBarButton.call(this,navbar);this.create()}PSVNavBarDownloadButton.prototype=Object.create(PSVNavBarButton.prototype);PSVNavBarDownloadButton.prototype.constructor=PSVNavBarDownloadButton;PSVNavBarDownloadButton.id='download';PSVNavBarDownloadButton.className='psv-button psv-button--hover-scale psv-download-button';PSVNavBarDownloadButton.icon='download.svg';PSVNavBarDownloadButton.prototype._onClick=function(){var link=document.createElement('a');link.href=this.psv.config.panorama;link.download=this.psv.config.panorama;this.psv.container.appendChild(link);link.click()};function PSVNavBarFullscreenButton(navbar){PSVNavBarButton.call(this,navbar);this.create()}PSVNavBarFullscreenButton.prototype=Object.create(PSVNavBarButton.prototype);PSVNavBarFullscreenButton.prototype.constructor=PSVNavBarFullscreenButton;PSVNavBarFullscreenButton.id='fullscreen';PSVNavBarFullscreenButton.className='psv-button psv-button--hover-scale psv-fullscreen-button';PSVNavBarFullscreenButton.icon='fullscreen-in.svg';PSVNavBarFullscreenButton.iconActive='fullscreen-out.svg';PSVNavBarFullscreenButton.prototype.create=function(){PSVNavBarButton.prototype.create.call(this);if(!PhotoSphereViewer.SYSTEM.fullscreenEvent){this.hide();console.warn('PhotoSphereViewer: fullscreen not supported.')}this.psv.on('fullscreen-updated',this)};PSVNavBarFullscreenButton.prototype.destroy=function(){this.psv.off('fullscreen-updated',this);PSVNavBarButton.prototype.destroy.call(this)};PSVNavBarFullscreenButton.prototype.handleEvent=function(e){switch(e.type){case'fullscreen-updated':this.toggleActive(e.args[0]);break}};PSVNavBarFullscreenButton.prototype._onClick=function(){this.psv.toggleFullscreen()};function PSVNavBarGyroscopeButton(navbar){PSVNavBarButton.call(this,navbar);this.create()}PSVNavBarGyroscopeButton.prototype=Object.create(PSVNavBarButton.prototype);PSVNavBarGyroscopeButton.prototype.constructor=PSVNavBarGyroscopeButton;PSVNavBarGyroscopeButton.id='gyroscope';PSVNavBarGyroscopeButton.className='psv-button psv-button--hover-scale psv-gyroscope-button';PSVNavBarGyroscopeButton.icon='compass.svg';PSVNavBarGyroscopeButton.prototype.create=function(){PSVNavBarButton.prototype.create.call(this);PhotoSphereViewer.SYSTEM.deviceOrientationSupported.promise.then(this._onAvailabilityChange.bind(this,true),this._onAvailabilityChange.bind(this,false));this.hide();this.psv.on('gyroscope-updated',this)};PSVNavBarGyroscopeButton.prototype.destroy=function(){this.psv.off('gyroscope-updated',this);PSVNavBarButton.prototype.destroy.call(this)};PSVNavBarGyroscopeButton.prototype.handleEvent=function(e){switch(e.type){case'gyroscope-updated':this.toggleActive(e.args[0]);break}};PSVNavBarGyroscopeButton.prototype._onClick=function(){this.psv.toggleGyroscopeControl()};PSVNavBarGyroscopeButton.prototype._onAvailabilityChange=function(available){if(available){if(PSVUtils.checkTHREE('DeviceOrientationControls')){this.show()}else{throw new PSVError('Missing Three.js components: DeviceOrientationControls. Get them from three.js-examples package.');}}};function PSVNavBarMarkersButton(navbar){PSVNavBarButton.call(this,navbar);this.create()}PSVNavBarMarkersButton.prototype=Object.create(PSVNavBarButton.prototype);PSVNavBarMarkersButton.prototype.constructor=PSVNavBarMarkersButton;PSVNavBarMarkersButton.id='markers';PSVNavBarMarkersButton.className='psv-button psv-button--hover-scale psv-markers-button';PSVNavBarMarkersButton.icon='pin.svg';PSVNavBarMarkersButton.prototype._onClick=function(){this.psv.hud.toggleMarkersList()};function PSVNavBarZoomButton(navbar){PSVNavBarButton.call(this,navbar);this.zoom_range=null;this.zoom_value=null;this.prop={mousedown:false,buttondown:false,longPressInterval:null,longPressTimeout:null};this.create()}PSVNavBarZoomButton.prototype=Object.create(PSVNavBarButton.prototype);PSVNavBarZoomButton.prototype.constructor=PSVNavBarZoomButton;PSVNavBarZoomButton.id='zoom';PSVNavBarZoomButton.className='psv-button psv-zoom-button';PSVNavBarZoomButton.prototype.create=function(){PSVNavBarButton.prototype.create.call(this);var zoom_minus=document.createElement('div');zoom_minus.className='psv-zoom-button-minus';zoom_minus.title=this.psv.config.lang.zoomOut;this._setIcon('zoom-out.svg',zoom_minus);this.container.appendChild(zoom_minus);var zoom_range_bg=document.createElement('div');zoom_range_bg.className='psv-zoom-button-range';this.container.appendChild(zoom_range_bg);this.zoom_range=document.createElement('div');this.zoom_range.className='psv-zoom-button-line';zoom_range_bg.appendChild(this.zoom_range);this.zoom_value=document.createElement('div');this.zoom_value.className='psv-zoom-button-handle';this.zoom_range.appendChild(this.zoom_value);var zoom_plus=document.createElement('div');zoom_plus.className='psv-zoom-button-plus';zoom_plus.title=this.psv.config.lang.zoomIn;this._setIcon('zoom-in.svg',zoom_plus);this.container.appendChild(zoom_plus);this.zoom_range.addEventListener('mousedown',this);this.zoom_range.addEventListener('touchstart',this);this.psv.container.addEventListener('mousemove',this);this.psv.container.addEventListener('touchmove',this);this.psv.container.addEventListener('mouseup',this);this.psv.container.addEventListener('touchend',this);zoom_minus.addEventListener('mousedown',this._zoomOut.bind(this));zoom_plus.addEventListener('mousedown',this._zoomIn.bind(this));this.psv.on('zoom-updated',this);this.psv.once('ready',function(){this._moveZoomValue(this.psv.prop.zoom_lvl)}.bind(this))};PSVNavBarZoomButton.prototype.destroy=function(){this._stopZoomChange();this.psv.container.removeEventListener('mousemove',this);this.psv.container.removeEventListener('touchmove',this);this.psv.container.removeEventListener('mouseup',this);this.psv.container.removeEventListener('touchend',this);delete this.zoom_range;delete this.zoom_value;this.psv.off('zoom-updated',this);PSVNavBarButton.prototype.destroy.call(this)};PSVNavBarZoomButton.prototype.handleEvent=function(e){switch(e.type){case'mousedown':this._initZoomChangeWithMouse(e);break;case'touchstart':this._initZoomChangeByTouch(e);break;case'mousemove':this._changeZoomWithMouse(e);break;case'touchmove':this._changeZoomByTouch(e);break;case'mouseup':this._stopZoomChange(e);break;case'touchend':this._stopZoomChange(e);break;case'zoom-updated':this._moveZoomValue(e.args[0]);break}};PSVNavBarZoomButton.prototype._moveZoomValue=function(level){this.zoom_value.style.left=(level/100*this.zoom_range.offsetWidth-this.zoom_value.offsetWidth/2)+'px'};PSVNavBarZoomButton.prototype._initZoomChangeWithMouse=function(evt){if(!this.enabled){return}this.prop.mousedown=true;this._changeZoom(evt.clientX)};PSVNavBarZoomButton.prototype._initZoomChangeByTouch=function(evt){if(!this.enabled){return}this.prop.mousedown=true;this._changeZoom(evt.changedTouches[0].clientX)};PSVNavBarZoomButton.prototype._zoomIn=function(){if(!this.enabled){return}this.prop.buttondown=true;this.psv.zoomIn();this.prop.longPressTimeout=window.setTimeout(this._startLongPressInterval.bind(this,1),200)};PSVNavBarZoomButton.prototype._zoomOut=function(){if(!this.enabled){return}this.prop.buttondown=true;this.psv.zoomOut();this.prop.longPressTimeout=window.setTimeout(this._startLongPressInterval.bind(this,-1),200)};PSVNavBarZoomButton.prototype._startLongPressInterval=function(value){if(this.prop.buttondown){this.prop.longPressInterval=window.setInterval(function(){this.psv.zoom(this.psv.prop.zoom_lvl+value)}.bind(this),50)}};PSVNavBarZoomButton.prototype._stopZoomChange=function(){if(!this.enabled){return}window.clearInterval(this.prop.longPressInterval);window.clearTimeout(this.prop.longPressTimeout);this.prop.longPressInterval=null;this.prop.mousedown=false;this.prop.buttondown=false};PSVNavBarZoomButton.prototype._changeZoomWithMouse=function(evt){if(!this.enabled){return}evt.preventDefault();this._changeZoom(evt.clientX)};PSVNavBarZoomButton.prototype._changeZoomByTouch=function(evt){if(!this.enabled){return}evt.preventDefault();this._changeZoom(evt.changedTouches[0].clientX)};PSVNavBarZoomButton.prototype._changeZoom=function(x){if(this.prop.mousedown){var user_input=parseInt(x)-this.zoom_range.getBoundingClientRect().left;var zoom_level=user_input/this.zoom_range.offsetWidth*100;this.psv.zoom(zoom_level)}};function PSVError(message){this.message=message;if('captureStackTrace'in Error){Error.captureStackTrace(this,PSVError)}else{this.stack=(new Error()).stack}}PSVError.prototype=Object.create(Error.prototype);PSVError.prototype.name='PSVError';PSVError.prototype.constructor=PSVError;PhotoSphereViewer.Error=PSVError;function PSVMarker(properties,psv){if(!properties.id){throw new PSVError('missing marker id');}if(properties.image&&(!properties.width||!properties.height)){throw new PSVError('missing marker width/height');}if(properties.image||properties.html){if((!properties.hasOwnProperty('x')||!properties.hasOwnProperty('y'))&&(!properties.hasOwnProperty('latitude')||!properties.hasOwnProperty('longitude'))){throw new PSVError('missing marker position, latitude/longitude or x/y');}}this.psv=psv;this.visible=true;this._dynamicSize=false;var _id=properties.id;var _type=PSVMarker.getType(properties,false);var $el;Object.defineProperties(this,{id:{configurable:false,enumerable:true,get:function(){return _id},set:function(value){}},type:{configurable:false,enumerable:true,get:function(){return _type},set:function(value){}},$el:{configurable:false,enumerable:true,get:function(){return $el},set:function(value){}},_def:{configurable:false,enumerable:true,get:function(){return this[_type]},set:function(value){this[_type]=value}}});if(this.isNormal()){$el=document.createElement('div')}else if(this.isPolygon()){$el=document.createElementNS(PSVUtils.svgNS,'polygon')}else if(this.isPolyline()){$el=document.createElementNS(PSVUtils.svgNS,'polyline')}else{$el=document.createElementNS(PSVUtils.svgNS,this.type)}$el.id='psv-marker-'+this.id;$el.psvMarker=this;this.update(properties)}PSVMarker.types=['image','html','polygon_px','polygon_rad','polyline_px','polyline_rad','rect','circle','ellipse','path'];PSVMarker.getType=function(properties,allowNone){var found=[];PSVMarker.types.forEach(function(type){if(properties[type]){found.push(type)}});if(found.length===0&&!allowNone){throw new PSVError('missing marker content, either '+PSVMarker.types.join(', '));}else if(found.length>1){throw new PSVError('multiple marker content, either '+PSVMarker.types.join(', '));}return found[0]};PSVMarker.prototype.destroy=function(){delete this.$el.psvMarker};PSVMarker.prototype.isNormal=function(){return this.type=='image'||this.type=='html'};PSVMarker.prototype.isPoly=function(){return this.isPolygon()||this.isPolyline()};PSVMarker.prototype.isPolygon=function(){return this.type=='polygon_px'||this.type=='polygon_rad'};PSVMarker.prototype.isPolyline=function(){return this.type=='polyline_px'||this.type=='polyline_rad'};PSVMarker.prototype.isSvg=function(){return this.type=='rect'||this.type=='circle'||this.type=='ellipse'||this.type=='path'};PSVMarker.prototype.getScale=function(zoomLevel){if(Array.isArray(this.scale)){return this.scale[0]+(this.scale[1]-this.scale[0])*PSVUtils.animation.easings.inQuad(zoomLevel/100)}else if(typeof this.scale=='function'){return this.scale(zoomLevel)}else if(typeof this.scale=='number'){return this.scale*PSVUtils.animation.easings.inQuad(zoomLevel/100)}else{return 1}};PSVMarker.prototype.update=function(properties){if(properties&&properties!==this){var newType=PSVMarker.getType(properties,true);if(newType!==undefined&&newType!==this.type){throw new PSVError('cannot change marker type');}PSVUtils.deepmerge(this,properties)}if(this.isNormal()){this.$el.setAttribute('class','psv-marker psv-marker--normal')}else{this.$el.setAttribute('class','psv-marker psv-marker--svg')}if(this.className){PSVUtils.addClasses(this.$el,this.className)}if(this.tooltip){PSVUtils.addClasses(this.$el,'has-tooltip');if(typeof this.tooltip==='string'){this.tooltip={content:this.tooltip}}}if(this.style){PSVUtils.deepmerge(this.$el.style,this.style)}this.anchor=PSVUtils.parsePosition(this.anchor);if(this.isNormal()){this._updateNormal()}else if(this.isPolygon()){this._updatePoly('polygon_rad','polygon_px')}else if(this.isPolyline()){this._updatePoly('polyline_rad','polyline_px')}else{this._updateSvg()}};PSVMarker.prototype._updateNormal=function(){if(this.width&&this.height){this.$el.style.width=this.width+'px';this.$el.style.height=this.height+'px';this._dynamicSize=false}else{this._dynamicSize=true}if(this.image){this.$el.style.backgroundImage='url('+this.image+')'}else{this.$el.innerHTML=this.html}this.$el.style.transformOrigin=this.anchor.left*100+'% '+this.anchor.top*100+'%';this.psv.cleanPosition(this);this.position3D=this.psv.sphericalCoordsToVector3(this)};PSVMarker.prototype._updateSvg=function(){this._dynamicSize=true;switch(this.type){case'rect':if(typeof this._def=='number'){this._def={x:0,y:0,width:this._def,height:this._def}}else if(Array.isArray(this._def)){this._def={x:0,y:0,width:this._def[0],height:this._def[1]}}else{this._def.x=this._def.y=0}break;case'circle':if(typeof this._def=='number'){this._def={cx:this._def,cy:this._def,r:this._def}}else if(Array.isArray(this._def)){this._def={cx:this._def[0],cy:this._def[0],r:this._def[0]}}else{this._def.cx=this._def.cy=this._def.r}break;case'ellipse':if(typeof this._def=='number'){this._def={cx:this._def,cy:this._def,rx:this._def,ry:this._def}}else if(Array.isArray(this._def)){this._def={cx:this._def[0],cy:this._def[1],rx:this._def[0],ry:this._def[1]}}else{this._def.cx=this._def.rx;this._def.cy=this._def.ry}break;case'path':if(typeof this._def=='string'){this._def={d:this._def}}break}Object.getOwnPropertyNames(this._def).forEach(function(prop){this.$el.setAttributeNS(null,prop,this._def[prop])},this);if(this.svgStyle){Object.getOwnPropertyNames(this.svgStyle).forEach(function(prop){this.$el.setAttributeNS(null,prop,this.svgStyle[prop])},this)}else{this.$el.setAttributeNS(null,'fill','rgba(0,0,0,0.5)')}this.psv.cleanPosition(this);this.position3D=this.psv.sphericalCoordsToVector3(this)};PSVMarker.prototype._updatePoly=function(key_rad,key_px){this._dynamicSize=true;if(this.svgStyle){Object.getOwnPropertyNames(this.svgStyle).forEach(function(prop){this.$el.setAttributeNS(null,prop,this.svgStyle[prop])},this);if(this.isPolyline()&&!this.svgStyle.fill){this.$el.setAttributeNS(null,'fill','none')}}else if(this.isPolygon()){this.$el.setAttributeNS(null,'fill','rgba(0,0,0,0.5)')}else if(this.isPolyline()){this.$el.setAttributeNS(null,'fill','none');this.$el.setAttributeNS(null,'stroke','rgb(0,0,0)')}[this[key_rad],this[key_px]].forEach(function(polygon){if(polygon&&typeof polygon[0]!='object'){for(var i=0;i<polygon.length;i++){polygon.splice(i,2,[polygon[i],polygon[i+1]])}}});if(this[key_px]){this[key_rad]=this[key_px].map(function(coord){var sphericalCoords=this.psv.textureCoordsToSphericalCoords({x:coord[0],y:coord[1]});return[sphericalCoords.longitude,sphericalCoords.latitude]},this)}else{this[key_rad]=this[key_rad].map(function(coord){return[PSVUtils.parseAngle(coord[0]),PSVUtils.parseAngle(coord[1],true)]})}this.longitude=this[key_rad][0][0];this.latitude=this[key_rad][0][1];this.positions3D=this[key_rad].map(function(coord){return this.psv.sphericalCoordsToVector3({longitude:coord[0],latitude:coord[1]})},this)};var PSVUtils={};PhotoSphereViewer.Utils=PSVUtils;PSVUtils.TwoPI=Math.PI*2.0;PSVUtils.HalfPI=Math.PI/2.0;PSVUtils.svgNS='http://www.w3.org/2000/svg';PSVUtils.checkTHREE=function(components){for(var i=0,l=arguments.length;i<l;i++){if(!(arguments[i]in THREE)){return false}}return true};PSVUtils.isCanvasSupported=function(){var canvas=document.createElement('canvas');return!!(canvas.getContext&&canvas.getContext('2d'))};PSVUtils.getWebGLCtx=function(){var canvas=document.createElement('canvas');var names=['webgl','experimental-webgl','moz-webgl','webkit-3d'];var context=null;if(!canvas.getContext){return null}if(names.some(function(name){try{context=canvas.getContext(name);return(context&&typeof context.getParameter=='function')}catch(e){return false}})){return context}else{return null}};PSVUtils.isWebGLSupported=function(){return!!window.WebGLRenderingContext&&PSVUtils.getWebGLCtx()!==null};PSVUtils.getMaxTextureWidth=function(){var ctx=PSVUtils.getWebGLCtx();if(ctx!==null){return ctx.getParameter(ctx.MAX_TEXTURE_SIZE)}};PSVUtils.toggleClass=function(element,className,active){if(!element.classList){var currentClassName=element.getAttribute('class')||'';var currentActive=currentClassName.indexOf(className)!==-1;var regex=new RegExp('(?:^|\\s)'+className+'(?:\\s|$)');if((active===undefined||active)&&!currentActive){currentClassName+=currentClassName.length>0?' '+className:className}else if(!active){currentClassName=currentClassName.replace(regex,' ')}element.setAttribute('class',currentClassName)}else{if(active===undefined){element.classList.toggle(className)}else if(active&&!element.classList.contains(className)){element.classList.add(className)}else if(!active){element.classList.remove(className)}}};PSVUtils.addClasses=function(element,className){if(!className){return}className.split(' ').forEach(function(name){PSVUtils.toggleClass(element,name,true)})};PSVUtils.removeClasses=function(element,className){if(!className){return}className.split(' ').forEach(function(name){PSVUtils.toggleClass(element,name,false)})};PSVUtils.hasParent=function(el,parent){do{if(el===parent){return true}}while(!!(el=el.parentNode));return false};PSVUtils.getClosest=function(el,selector){var matches=el.matches||el.msMatchesSelector;do{if(matches.bind(el)(selector)){return el}}while(!!(el=el.parentElement));return null};PSVUtils.mouseWheelEvent=function(){return'onwheel'in document.createElement('div')?'wheel':document.onmousewheel!==undefined?'mousewheel':'DOMMouseScroll'};PSVUtils.fullscreenEvent=function(){var map={'exitFullscreen':'fullscreenchange','webkitExitFullscreen':'webkitfullscreenchange','mozCancelFullScreen':'mozfullscreenchange','msExitFullscreen':'MSFullscreenChange'};for(var exit in map){if(exit in document)return map[exit]}};PSVUtils.bound=function(x,min,max){return Math.max(min,Math.min(max,x))};PSVUtils.isInteger=Number.isInteger||function(value){return typeof value==='number'&&isFinite(value)&&Math.floor(value)===value};PSVUtils.sum=function(array){return array.reduce(function(a,b){return a+b},0)};PSVUtils.getXMPValue=function(data,attr){var result;if((result=data.match('<GPano:'+attr+'>(.*)</GPano:'+attr+'>'))!==null){return result[1]}else if((result=data.match('GPano:'+attr+'="(.*?)"'))!==null){return result[1]}else{return null}};PSVUtils.isFullscreenEnabled=function(elt){return(document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement)===elt};PSVUtils.requestFullscreen=function(elt){(elt.requestFullscreen||elt.mozRequestFullScreen||elt.webkitRequestFullscreen||elt.msRequestFullscreen).call(elt)};PSVUtils.exitFullscreen=function(){(document.exitFullscreen||document.mozCancelFullScreen||document.webkitExitFullscreen||document.msExitFullscreen).call(document)};PSVUtils.getStyle=function(elt,prop){return window.getComputedStyle(elt,null)[prop]};PSVUtils.getShortestArc=function(from,to){var tCandidates=[0,PSVUtils.TwoPI,-PSVUtils.TwoPI];return tCandidates.reduce(function(value,candidate){candidate=to-from+candidate;return Math.abs(candidate)<Math.abs(value)?candidate:value},Infinity)};PSVUtils.parsePosition=function(value){if(!value){return{top:0.5,left:0.5}}if(typeof value==='object'){return value}var tokens=value.toLocaleLowerCase().split(' ').slice(0,2);if(tokens.length===1){if(PSVUtils.parsePosition.positions[tokens[0]]!==undefined){tokens=[tokens[0],'center']}else{tokens=[tokens[0],tokens[0]]}}var xFirst=tokens[1]!='left'&&tokens[1]!='right'&&tokens[0]!='top'&&tokens[0]!='bottom';tokens=tokens.map(function(token){return PSVUtils.parsePosition.positions[token]||token});if(!xFirst){tokens.reverse()}var parsed=tokens.join(' ').match(/^([0-9.]+)% ([0-9.]+)%$/);if(parsed){return{left:parsed[1]/100,top:parsed[2]/100}}else{return{top:0.5,left:0.5}}};PSVUtils.parsePosition.positions={'top':'0%','bottom':'100%','left':'0%','right':'100%','center':'50%'};PSVUtils.parseSpeed=function(speed){if(typeof speed=='string'){speed=speed.toString().trim();var speed_value=parseFloat(speed.replace(/^(-?[0-9]+(?:\.[0-9]*)?).*$/,'$1'));var speed_unit=speed.replace(/^-?[0-9]+(?:\.[0-9]*)?(.*)$/,'$1').trim();if(speed_unit.match(/(pm|per minute)$/)){speed_value/=60}switch(speed_unit){case'dpm':case'degrees per minute':case'dps':case'degrees per second':speed=THREE.Math.degToRad(speed_value);break;case'radians per minute':case'radians per second':speed=speed_value;break;case'rpm':case'revolutions per minute':case'rps':case'revolutions per second':speed=speed_value*PSVUtils.TwoPI;break;default:throw new PSVError('unknown speed unit "'+speed_unit+'"');}}return speed};PSVUtils.parseAngle=function(angle,zeroCenter){if(typeof angle==='string'){var match=angle.toLowerCase().trim().match(/^(-?[0-9]+(?:\.[0-9]*)?)(.*)$/);if(!match){throw new PSVError('unknown angle "'+angle+'"');}var value=parseFloat(match[1]);var unit=match[2];if(unit){switch(unit){case'deg':case'degs':angle=THREE.Math.degToRad(value);break;case'rad':case'rads':angle=value;break;default:throw new PSVError('unknown angle unit "'+unit+'"');}}else{angle=value}}angle=(zeroCenter?angle+Math.PI:angle)%PSVUtils.TwoPI;if(angle<0){angle=PSVUtils.TwoPI+angle}return zeroCenter?PSVUtils.bound(angle-Math.PI,-PSVUtils.HalfPI,PSVUtils.HalfPI):angle};PSVUtils.cleanTHREEScene=function(scene){scene.children.forEach(function(item){if(item instanceof THREE.Mesh){if(item.geometry){item.geometry.dispose();item.geometry=null}if(item.material){if(item.material.materials){item.material.materials.forEach(function(material){if(material.map){material.map.dispose();material.map=null}material.dispose()});item.material.materials.length=0}else{if(item.material.map){item.material.map.dispose();item.material.map=null}item.material.dispose()}item.material=null}}});scene.children.length=0};PSVUtils.animation=function(options){var defer=D(false);var start=null;if(!options.easing||typeof options.easing=='string'){options.easing=PSVUtils.animation.easings[options.easing||'linear']}function run(timestamp){if(defer.promise.getStatus()===-1){return}if(start===null){start=timestamp}var progress=(timestamp-start)/options.duration;var current={};var name;if(progress<1.0){for(name in options.properties){current[name]=options.properties[name].start+(options.properties[name].end-options.properties[name].start)*options.easing(progress)}options.onTick(current,progress);window.requestAnimationFrame(run)}else{for(name in options.properties){current[name]=options.properties[name].end}options.onTick(current,1.0);window.requestAnimationFrame(function(){defer.resolve()})}}if(options.delay!==undefined){window.setTimeout(function(){window.requestAnimationFrame(run)},options.delay)}else{window.requestAnimationFrame(run)}var promise=defer.promise;promise.cancel=function(){defer.reject()};return promise};PSVUtils.animation.easings={linear:function(t){return t},inQuad:function(t){return t*t},outQuad:function(t){return t*(2-t)},inOutQuad:function(t){return t<.5?2*t*t:-1+(4-2*t)*t},inCubic:function(t){return t*t*t},outCubic:function(t){return(--t)*t*t+1},inOutCubic:function(t){return t<.5?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1},inQuart:function(t){return t*t*t*t},outQuart:function(t){return 1-(--t)*t*t*t},inOutQuart:function(t){return t<.5?8*t*t*t*t:1-8*(--t)*t*t*t},inQuint:function(t){return t*t*t*t*t},outQuint:function(t){return 1+(--t)*t*t*t*t},inOutQuint:function(t){return t<.5?16*t*t*t*t*t:1+16*(--t)*t*t*t*t},inSine:function(t){return 1-Math.cos(t*(Math.PI/2))},outSine:function(t){return Math.sin(t*(Math.PI/2))},inOutSine:function(t){return.5-.5*Math.cos(Math.PI*t)},inExpo:function(t){return Math.pow(2,10*(t-1))},outExpo:function(t){return 1-Math.pow(2,-10*t)},inOutExpo:function(t){t=t*2-1;return t<0?.5*Math.pow(2,10*t):1-.5*Math.pow(2,-10*t)},inCirc:function(t){return 1-Math.sqrt(1-t*t)},outCirc:function(t){t--;return Math.sqrt(1-t*t)},inOutCirc:function(t){t*=2;return t<1?.5-.5*Math.sqrt(1-t*t):.5+.5*Math.sqrt(1-(t-=2)*t)}};PSVUtils.throttle=function(func,wait){var self,args,result;var timeout=null;var previous=0;var later=function(){previous=Date.now();timeout=null;result=func.apply(self,args);if(!timeout)self=args=null};return function(){var now=Date.now();if(!previous)previous=now;var remaining=wait-(now-previous);self=this;args=arguments;if(remaining<=0||remaining>wait){if(timeout){clearTimeout(timeout);timeout=null}previous=now;result=func.apply(self,args);if(!timeout)self=args=null}else if(!timeout){timeout=setTimeout(later,remaining)}return result}};PSVUtils.isPlainObject=function(obj){if(typeof obj=='object'&&obj!==null){if(typeof Object.getPrototypeOf=='function'){var proto=Object.getPrototypeOf(obj);return proto===Object.prototype||proto===null}return Object.prototype.toString.call(obj)=='[object Object]'}return false};PSVUtils.deepmerge=function(target,src){var first=src;return(function merge(target,src){if(Array.isArray(src)){if(!target||!Array.isArray(target)){target=[]}else{target.length=0}src.forEach(function(e,i){target[i]=merge(null,e)})}else if(typeof src=='object'){if(!target||Array.isArray(target)){target={}}Object.keys(src).forEach(function(key){if(typeof src[key]!='object'||!src[key]||!PSVUtils.isPlainObject(src[key])){target[key]=src[key]}else if(src[key]!=first){if(!target[key]){target[key]=merge(null,src[key])}else{merge(target[key],src[key])}}})}else{target=src}return target}(target,src))};PSVUtils.clone=function(src){return PSVUtils.deepmerge(null,src)};PSVUtils.normalizeWheel=function(event){var PIXEL_STEP=10;var LINE_HEIGHT=40;var PAGE_HEIGHT=800;var sX=0,sY=0;var pX=0,pY=0;if('detail'in event){sY=event.detail}if('wheelDelta'in event){sY=-event.wheelDelta/120}if('wheelDeltaY'in event){sY=-event.wheelDeltaY/120}if('wheelDeltaX'in event){sX=-event.wheelDeltaX/120}if('axis'in event&&event.axis===event.HORIZONTAL_AXIS){sX=sY;sY=0}pX=sX*PIXEL_STEP;pY=sY*PIXEL_STEP;if('deltaY'in event){pY=event.deltaY}if('deltaX'in event){pX=event.deltaX}if((pX||pY)&&event.deltaMode){if(event.deltaMode==1){pX*=LINE_HEIGHT;pY*=LINE_HEIGHT}else{pX*=PAGE_HEIGHT;pY*=PAGE_HEIGHT}}if(pX&&!sX){sX=(pX<1)?-1:1}if(pY&&!sY){sY=(pY<1)?-1:1}return{spinX:sX,spinY:sY,pixelX:pX,pixelY:pY}};(function(w){"use strict";w.requestAnimationFrame=w.requestAnimationFrame||w.mozRequestAnimationFrame||w.webkitRequestAnimationFrame||w.msRequestAnimationFrame;w.cancelAnimationFrame=w.cancelAnimationFrame||w.mozCancelAnimationFrame||w.webkitCancelAnimationFrame||w.msCancelAnimationFrame;if(!w.requestAnimationFrame){var aAnimQueue=[],aProcessing=[],iRequestId=0,iIntervalId;w.requestAnimationFrame=function(callback){aAnimQueue.push([++iRequestId,callback]);if(!iIntervalId){iIntervalId=setInterval(function(){if(aAnimQueue.length){var time=+new Date();var temp=aProcessing;aProcessing=aAnimQueue;aAnimQueue=temp;while(aProcessing.length){aProcessing.shift()[1](time)}}else{clearInterval(iIntervalId);iIntervalId=undefined}},1000/50)}return iRequestId};w.cancelAnimationFrame=function(requestId){var i,j;for(i=0,j=aAnimQueue.length;i<j;i+=1){if(aAnimQueue[i][0]===requestId){aAnimQueue.splice(i,1);return}}for(i=0,j=aProcessing.length;i<j;i+=1){if(aProcessing[i][0]===requestId){aProcessing.splice(i,1);return}}}}})(window);PhotoSphereViewer.ICONS['compass.svg']='<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 100 100" enable-background="new 0 0 100 100" xml:space="preserve"><path d="M49.997,0C22.38,0.004,0.005,22.383,0,50.002C0.005,77.614,22.38,99.995,49.997,100C77.613,99.995,99.996,77.614,100,50.002C99.996,22.383,77.613,0.004,49.997,0z M49.997,88.81c-21.429-0.04-38.772-17.378-38.809-38.807c0.037-21.437,17.381-38.775,38.809-38.812C71.43,11.227,88.769,28.567,88.81,50.002C88.769,71.432,71.43,88.77,49.997,88.81z"/><path d="M72.073,25.891L40.25,41.071l-0.003-0.004l-0.003,0.009L27.925,74.109l31.82-15.182l0.004,0.004l0.002-0.007l-0.002-0.004L72.073,25.891z M57.837,54.411L44.912,42.579l21.092-10.062L57.837,54.411z"/><!--Created by iconoci from the Noun Project--></svg>';PhotoSphereViewer.ICONS['download.svg']='<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" viewBox="0 0 100 100" enable-background="new 0 0 100 100" xml:space="preserve"><path d="M83.285,35.575H66.271L66.277,3H32.151v32.575H16.561l33.648,32.701L83.285,35.575z"/><path d="M83.316,64.199v16.32H16.592v-16.32H-0.094v32.639H100V64.199H83.316z"/><!--Created by Michael Zenaty from the Noun Project--></svg>';PhotoSphereViewer.ICONS['fullscreen-in.svg']='<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" viewBox="0 0 100 100" enable-background="new 0 0 100 100" xml:space="preserve"><polygon points="100,39.925 87.105,39.925 87.105,18.895 66.075,18.895 66.075,6 100,6"/><polygon points="100,93.221 66.075,93.221 66.075,80.326 87.105,80.326 87.105,59.295 100,59.295"/><polygon points="33.925,93.221 0,93.221 0,59.295 12.895,59.295 12.895,80.326 33.925,80.326"/><polygon points="12.895,39.925 0,39.925 0,6 33.925,6 33.925,18.895 12.895,18.895"/><!--Created by Garrett Knoll from the Noun Project--></svg>';PhotoSphereViewer.ICONS['fullscreen-out.svg']='<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" viewBox="0 0 100 100" enable-background="new 0 0 100 100" xml:space="preserve"><polygon points="66.075,7 78.969,7 78.969,28.031 100,28.031 100,40.925 66.075,40.925"/><polygon points="66.075,60.295 100,60.295 100,73.19 78.969,73.19 78.969,94.221 66.075,94.221"/><polygon points="0,60.295 33.925,60.295 33.925,94.221 21.031,94.221 21.031,73.19 0,73.19"/><polygon points="21.031,7 33.925,7 33.925,40.925 0,40.925 0,28.031 21.031,28.031"/><!--Created by Garrett Knoll from the Noun Project--></svg>';PhotoSphereViewer.ICONS['pin.svg']='<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" viewBox="0 0 48 48" enable-background="new 0 0 48 48" xml:space="preserve"><path d="M24,0C13.798,0,5.499,8.3,5.499,18.501c0,10.065,17.57,28.635,18.318,29.421C23.865,47.972,23.931,48,24,48s0.135-0.028,0.183-0.078c0.748-0.786,18.318-19.355,18.318-29.421C42.501,8.3,34.202,0,24,0z M24,7.139c5.703,0,10.342,4.64,10.342,10.343c0,5.702-4.639,10.342-10.342,10.342c-5.702,0-10.34-4.64-10.34-10.342C13.66,11.778,18.298,7.139,24,7.139z"/><!--Created by Daniele Marucci from the Noun Project--></svg>';PhotoSphereViewer.ICONS['play-active.svg']='<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 41 41" enable-background="new 0 0 41 41" xml:space="preserve"><path d="M40.5,14.1c-0.1-0.1-1.2-0.5-2.898-1C37.5,13.1,37.4,13,37.4,12.9C34.5,6.5,28,2,20.5,2S6.6,6.5,3.7,12.9c0,0.1-0.1,0.1-0.2,0.2c-1.7,0.6-2.8,1-2.9,1L0,14.4v12.1l0.6,0.2c0.1,0,1.1,0.399,2.7,0.899c0.1,0,0.2,0.101,0.2,0.199C6.3,34.4,12.9,39,20.5,39c7.602,0,14.102-4.6,16.9-11.1c0-0.102,0.1-0.102,0.199-0.2c1.699-0.601,2.699-1,2.801-1l0.6-0.3V14.3L40.5,14.1z M6.701,11.5C9.7,7,14.8,4,20.5,4c5.8,0,10.9,3,13.8,7.5c0.2,0.3-0.1,0.6-0.399,0.5c-3.799-1-8.799-2-13.6-2c-4.7,0-9.5,1-13.2,2C6.801,12.1,6.601,11.8,6.701,11.5z M25.1,20.3L18.7,24c-0.3,0.2-0.7,0-0.7-0.5v-7.4c0-0.4,0.4-0.6,0.7-0.4 l6.399,3.8C25.4,19.6,25.4,20.1,25.1,20.3z M34.5,29.201C31.602,33.9,26.4,37,20.5,37c-5.9,0-11.1-3.1-14-7.898c-0.2-0.302,0.1-0.602,0.4-0.5c3.9,1,8.9,2.1,13.6,2.1c5,0,9.9-1,13.602-2C34.4,28.602,34.602,28.9,34.5,29.201z"/><!--Created by Nick Bluth from the Noun Project--></svg>';PhotoSphereViewer.ICONS['play.svg']='<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" viewBox="0 0 41 41" enable-background="new 0 0 41 41" xml:space="preserve"><path d="M40.5,14.1c-0.1-0.1-1.2-0.5-2.899-1c-0.101,0-0.2-0.1-0.2-0.2C34.5,6.5,28,2,20.5,2S6.6,6.5,3.7,12.9c0,0.1-0.1,0.1-0.2,0.2c-1.7,0.6-2.8,1-2.9,1L0,14.4v12.1l0.6,0.2c0.1,0,1.1,0.4,2.7,0.9c0.1,0,0.2,0.1,0.2,0.199C6.3,34.4,12.9,39,20.5,39c7.601,0,14.101-4.6,16.9-11.1c0-0.101,0.1-0.101,0.2-0.2c1.699-0.6,2.699-1,2.8-1l0.6-0.3V14.3L40.5,14.1zM20.5,4c5.8,0,10.9,3,13.8,7.5c0.2,0.3-0.1,0.6-0.399,0.5c-3.8-1-8.8-2-13.6-2c-4.7,0-9.5,1-13.2,2c-0.3,0.1-0.5-0.2-0.4-0.5C9.7,7,14.8,4,20.5,4z M20.5,37c-5.9,0-11.1-3.1-14-7.899c-0.2-0.301,0.1-0.601,0.4-0.5c3.9,1,8.9,2.1,13.6,2.1c5,0,9.9-1,13.601-2c0.3-0.1,0.5,0.2,0.399,0.5C31.601,33.9,26.4,37,20.5,37z M39.101,24.9c0,0.1-0.101,0.3-0.2,0.3c-2.5,0.9-10.4,3.6-18.4,3.6c-7.1,0-15.6-2.699-18.3-3.6C2.1,25.2,2,25,2,24.9V16c0-0.1,0.1-0.3,0.2-0.3c2.6-0.9,10.6-3.6,18.2-3.6c7.5,0,15.899,2.7,18.5,3.6c0.1,0,0.2,0.2,0.2,0.3V24.9z"/><path d="M18.7,24l6.4-3.7c0.3-0.2,0.3-0.7,0-0.8l-6.4-3.8c-0.3-0.2-0.7,0-0.7,0.4v7.4C18,24,18.4,24.2,18.7,24z"/><!--Created by Nick Bluth from the Noun Project--></svg>';PhotoSphereViewer.ICONS['zoom-in.svg']='<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve"><path d="M14.043,12.22c2.476-3.483,1.659-8.313-1.823-10.789C8.736-1.044,3.907-0.228,1.431,3.255c-2.475,3.482-1.66,8.312,1.824,10.787c2.684,1.908,6.281,1.908,8.965,0l4.985,4.985c0.503,0.504,1.32,0.504,1.822,0c0.505-0.503,0.505-1.319,0-1.822L14.043,12.22z M7.738,13.263c-3.053,0-5.527-2.475-5.527-5.525c0-3.053,2.475-5.527,5.527-5.527c3.05,0,5.524,2.474,5.524,5.527C13.262,10.789,10.788,13.263,7.738,13.263z"/><polygon points="8.728,4.009 6.744,4.009 6.744,6.746 4.006,6.746 4.006,8.73 6.744,8.73 6.744,11.466 8.728,11.466 8.728,8.73 11.465,8.73 11.465,6.746 8.728,6.746"/><!--Created by Ryan Canning from the Noun Project--></svg>';PhotoSphereViewer.ICONS['zoom-out.svg']='<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve"><path d="M14.043,12.22c2.476-3.483,1.659-8.313-1.823-10.789C8.736-1.044,3.907-0.228,1.431,3.255c-2.475,3.482-1.66,8.312,1.824,10.787c2.684,1.908,6.281,1.908,8.965,0l4.985,4.985c0.503,0.504,1.32,0.504,1.822,0c0.505-0.503,0.505-1.319,0-1.822L14.043,12.22z M7.738,13.263c-3.053,0-5.527-2.475-5.527-5.525c0-3.053,2.475-5.527,5.527-5.527c3.05,0,5.524,2.474,5.524,5.527C13.262,10.789,10.788,13.263,7.738,13.263z"/><rect x="4.006" y="6.746" width="7.459" height="1.984"/><!--Created by Ryan Canning from the Noun Project--></svg>';return PhotoSphereViewer}));var f=function(object){var scope=this;this.object=object;this.object.rotation.reorder('YXZ');this.enabled=true;this.deviceOrientation={};this.screenOrientation=0;this.alphaOffset=0;var onDeviceOrientationChangeEvent=function(event){scope.deviceOrientation=event};var onScreenOrientationChangeEvent=function(){scope.screenOrientation=window.orientation||0};var setObjectQuaternion=function(){var zee=new THREE.Vector3(0,0,1);var euler=new THREE.Euler();var q0=new THREE.Quaternion();var q1=new THREE.Quaternion(-Math.sqrt(0.5),0,0,Math.sqrt(0.5));return function(quaternion,alpha,beta,gamma,orient){euler.set(beta,alpha,-gamma,'YXZ');quaternion.setFromEuler(euler);quaternion.multiply(q1);quaternion.multiply(q0.setFromAxisAngle(zee,-orient))}}();this.connect=function(){onScreenOrientationChangeEvent();window.addEventListener('orientationchange',onScreenOrientationChangeEvent,false);window.addEventListener('deviceorientation',onDeviceOrientationChangeEvent,false);scope.enabled=true};this.disconnect=function(){window.removeEventListener('orientationchange',onScreenOrientationChangeEvent,false);window.removeEventListener('deviceorientation',onDeviceOrientationChangeEvent,false);scope.enabled=false};this.update=function(){if(scope.enabled===false)return;var device=scope.deviceOrientation;if(device){var alpha=device.alpha?THREE.Math.degToRad(device.alpha)+scope.alphaOffset:0;var beta=device.beta?THREE.Math.degToRad(device.beta):0;var gamma=device.gamma?THREE.Math.degToRad(device.gamma):0;var orient=scope.screenOrientation?THREE.Math.degToRad(scope.screenOrientation):0;setObjectQuaternion(scope.object.quaternion,alpha,beta,gamma,orient)}};this.dispose=function(){scope.disconnect()};this.connect()};